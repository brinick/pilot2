
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pilot.control.job &#8212; Pilot 2  documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pilot.control.job</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1"># http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Authors:</span>
<span class="c1"># - Mario Lassnig, mario.lassnig@cern.ch, 2016-2017</span>
<span class="c1"># - Daniel Drizhuk, d.drizhuk@gmail.com, 2017</span>
<span class="c1"># - Paul Nilsson, paul.nilsson@cern.ch, 2017-2020</span>
<span class="c1"># - Wen Guan, wen.guan@cern.ch, 2018</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>  <span class="c1"># Python 2</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">socket</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">Queue</span> <span class="k">as</span> <span class="nn">queue</span>  <span class="c1"># noqa: N813</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">queue</span>  <span class="c1"># Python 3</span>

<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">dumps</span>
<span class="kn">from</span> <span class="nn">re</span> <span class="kn">import</span> <span class="n">findall</span>

<span class="kn">from</span> <span class="nn">pilot.common.errorcodes</span> <span class="kn">import</span> <span class="n">ErrorCodes</span>
<span class="kn">from</span> <span class="nn">pilot.common.exception</span> <span class="kn">import</span> <span class="n">ExcThread</span><span class="p">,</span> <span class="n">PilotException</span>  <span class="c1">#, JobAlreadyRunning</span>
<span class="kn">from</span> <span class="nn">pilot.info</span> <span class="kn">import</span> <span class="n">infosys</span><span class="p">,</span> <span class="n">JobData</span><span class="p">,</span> <span class="n">InfoService</span><span class="p">,</span> <span class="n">JobInfoProvider</span>
<span class="kn">from</span> <span class="nn">pilot.util</span> <span class="kn">import</span> <span class="n">https</span>
<span class="kn">from</span> <span class="nn">pilot.util.auxiliary</span> <span class="kn">import</span> <span class="n">get_batchsystem_jobid</span><span class="p">,</span> <span class="n">get_job_scheduler_id</span><span class="p">,</span> <span class="n">get_pilot_id</span><span class="p">,</span> \
    <span class="n">set_pilot_state</span><span class="p">,</span> <span class="n">get_pilot_state</span><span class="p">,</span> <span class="n">check_for_final_server_update</span><span class="p">,</span> <span class="n">pilot_version_banner</span><span class="p">,</span> <span class="n">is_virtual_machine</span><span class="p">,</span> \
    <span class="n">is_python3</span><span class="p">,</span> <span class="n">show_memory_usage</span>
<span class="kn">from</span> <span class="nn">pilot.util.config</span> <span class="kn">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">pilot.util.common</span> <span class="kn">import</span> <span class="n">should_abort</span><span class="p">,</span> <span class="n">was_pilot_killed</span>
<span class="kn">from</span> <span class="nn">pilot.util.constants</span> <span class="kn">import</span> <span class="n">PILOT_MULTIJOB_START_TIME</span><span class="p">,</span> <span class="n">PILOT_PRE_GETJOB</span><span class="p">,</span> <span class="n">PILOT_POST_GETJOB</span><span class="p">,</span> <span class="n">PILOT_KILL_SIGNAL</span><span class="p">,</span> <span class="n">LOG_TRANSFER_NOT_DONE</span><span class="p">,</span> \
    <span class="n">LOG_TRANSFER_IN_PROGRESS</span><span class="p">,</span> <span class="n">LOG_TRANSFER_DONE</span><span class="p">,</span> <span class="n">LOG_TRANSFER_FAILED</span><span class="p">,</span> <span class="n">SERVER_UPDATE_TROUBLE</span><span class="p">,</span> <span class="n">SERVER_UPDATE_FINAL</span><span class="p">,</span> \
    <span class="n">SERVER_UPDATE_UPDATING</span><span class="p">,</span> <span class="n">SERVER_UPDATE_NOT_DONE</span>
<span class="kn">from</span> <span class="nn">pilot.util.container</span> <span class="kn">import</span> <span class="n">execute</span>
<span class="kn">from</span> <span class="nn">pilot.util.filehandling</span> <span class="kn">import</span> <span class="n">get_files</span><span class="p">,</span> <span class="n">tail</span><span class="p">,</span> <span class="n">is_json</span><span class="p">,</span> <span class="n">copy</span><span class="p">,</span> <span class="n">remove</span><span class="p">,</span> <span class="n">read_file</span><span class="p">,</span> <span class="n">write_json</span><span class="p">,</span> <span class="n">establish_logging</span><span class="p">,</span> <span class="n">write_file</span>
<span class="kn">from</span> <span class="nn">pilot.util.harvester</span> <span class="kn">import</span> <span class="n">request_new_jobs</span><span class="p">,</span> <span class="n">remove_job_request_file</span><span class="p">,</span> <span class="n">parse_job_definition_file</span><span class="p">,</span> \
    <span class="n">is_harvester_mode</span><span class="p">,</span> <span class="n">get_worker_attributes_file</span><span class="p">,</span> <span class="n">publish_job_report</span><span class="p">,</span> <span class="n">publish_work_report</span><span class="p">,</span> <span class="n">get_event_status_file</span><span class="p">,</span> \
    <span class="n">publish_stageout_files</span>
<span class="kn">from</span> <span class="nn">pilot.util.jobmetrics</span> <span class="kn">import</span> <span class="n">get_job_metrics</span>
<span class="kn">from</span> <span class="nn">pilot.util.math</span> <span class="kn">import</span> <span class="n">mean</span>
<span class="kn">from</span> <span class="nn">pilot.util.monitoring</span> <span class="kn">import</span> <span class="n">job_monitor_tasks</span><span class="p">,</span> <span class="n">check_local_space</span>
<span class="kn">from</span> <span class="nn">pilot.util.monitoringtime</span> <span class="kn">import</span> <span class="n">MonitoringTime</span>
<span class="kn">from</span> <span class="nn">pilot.util.processes</span> <span class="kn">import</span> <span class="n">cleanup</span><span class="p">,</span> <span class="n">threads_aborted</span>
<span class="kn">from</span> <span class="nn">pilot.util.proxy</span> <span class="kn">import</span> <span class="n">get_distinguished_name</span>
<span class="kn">from</span> <span class="nn">pilot.util.queuehandling</span> <span class="kn">import</span> <span class="n">scan_for_jobs</span><span class="p">,</span> <span class="n">put_in_queue</span><span class="p">,</span> <span class="n">queue_report</span>
<span class="kn">from</span> <span class="nn">pilot.util.timing</span> <span class="kn">import</span> <span class="n">add_to_pilot_timing</span><span class="p">,</span> <span class="n">timing_report</span><span class="p">,</span> <span class="n">get_postgetjob_time</span><span class="p">,</span> <span class="n">get_time_since</span><span class="p">,</span> <span class="n">time_stamp</span>
<span class="kn">from</span> <span class="nn">pilot.util.workernode</span> <span class="kn">import</span> <span class="n">get_disk_space</span><span class="p">,</span> <span class="n">collect_workernode_info</span><span class="p">,</span> <span class="n">get_node_name</span><span class="p">,</span> <span class="n">get_cpu_model</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">errors</span> <span class="o">=</span> <span class="n">ErrorCodes</span><span class="p">()</span>


<div class="viewcode-block" id="control"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.control">[docs]</a><span class="k">def</span> <span class="nf">control</span><span class="p">(</span><span class="n">queues</span><span class="p">,</span> <span class="n">traces</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main function of job control.</span>

<span class="sd">    :param queues: internal queues for job handling.</span>
<span class="sd">    :param traces: tuple containing internal pilot states.</span>
<span class="sd">    :param args: Pilot arguments (e.g. containing queue name, queuedata dictionary, etc).</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># t = threading.current_thread()</span>
    <span class="c1"># logger.debug(&#39;job.control is run by thread: %s&#39; % t.name)</span>

    <span class="n">targets</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;validate&#39;</span><span class="p">:</span> <span class="n">validate</span><span class="p">,</span> <span class="s1">&#39;retrieve&#39;</span><span class="p">:</span> <span class="n">retrieve</span><span class="p">,</span> <span class="s1">&#39;create_data_payload&#39;</span><span class="p">:</span> <span class="n">create_data_payload</span><span class="p">,</span>
               <span class="s1">&#39;queue_monitor&#39;</span><span class="p">:</span> <span class="n">queue_monitor</span><span class="p">,</span> <span class="s1">&#39;job_monitor&#39;</span><span class="p">:</span> <span class="n">job_monitor</span><span class="p">}</span>
    <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="n">ExcThread</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(),</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;queues&#39;</span><span class="p">:</span> <span class="n">queues</span><span class="p">,</span> <span class="s1">&#39;traces&#39;</span><span class="p">:</span> <span class="n">traces</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="n">args</span><span class="p">},</span>
                         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">targets</span><span class="o">.</span><span class="n">items</span><span class="p">())]</span>  <span class="c1"># Python 2/3</span>

    <span class="p">[</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">]</span>

    <span class="c1"># if an exception is thrown, the graceful_stop will be set by the ExcThread class run() function</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">graceful_stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
            <span class="n">bucket</span> <span class="o">=</span> <span class="n">thread</span><span class="o">.</span><span class="n">get_bucket</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">exc</span> <span class="o">=</span> <span class="n">bucket</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_obj</span><span class="p">,</span> <span class="n">exc_trace</span> <span class="o">=</span> <span class="n">exc</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;thread </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s2"> received an exception from bucket: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">exc_obj</span><span class="p">))</span>

                <span class="c1"># deal with the exception</span>
                <span class="c1"># ..</span>

            <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;job control ending since graceful_stop has been set&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">abort_job</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">traces</span><span class="o">.</span><span class="n">pilot</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;aborting&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;jobs are aborting&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">traces</span><span class="o">.</span><span class="n">pilot</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;abort&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;job control detected a set abort_job (due to a kill signal)&#39;</span><span class="p">)</span>
            <span class="n">traces</span><span class="o">.</span><span class="n">pilot</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;aborting&#39;</span>

            <span class="c1"># find all running jobs and stop them, find all jobs in queues relevant to this module</span>
            <span class="c1">#abort_jobs_in_queues(queues, args.signal)</span>

    <span class="c1"># proceed to set the job_aborted flag?</span>
    <span class="k">if</span> <span class="n">threads_aborted</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;will proceed to set job_aborted&#39;</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">job_aborted</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;will not set job_aborted yet&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;[job] control thread has finished&#39;</span><span class="p">)</span></div>
    <span class="c1"># test kill signal during end of generic workflow</span>
    <span class="c1">#import signal</span>
    <span class="c1">#os.kill(os.getpid(), signal.SIGBUS)</span>


<div class="viewcode-block" id="_validate_job"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job._validate_job">[docs]</a><span class="k">def</span> <span class="nf">_validate_job</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verify job parameters for specific problems.</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :return: Boolean.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pilot_user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PILOT_USER&#39;</span><span class="p">,</span> <span class="s1">&#39;generic&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;pilot.user.</span><span class="si">%s</span><span class="s1">.common&#39;</span> <span class="o">%</span> <span class="n">pilot_user</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[</span><span class="n">pilot_user</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Python 2/3</span>
    <span class="n">container</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;pilot.user.</span><span class="si">%s</span><span class="s1">.container&#39;</span> <span class="o">%</span> <span class="n">pilot_user</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[</span><span class="n">user</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Python 2/3</span>

    <span class="c1"># should a container be used for the payload?</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;job&#39;</span><span class="p">:</span> <span class="n">job</span><span class="p">}</span>
        <span class="n">job</span><span class="o">.</span><span class="n">usecontainer</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">do_use_container</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;exception caught: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">verify_job</span><span class="p">(</span><span class="n">job</span><span class="p">)</span> <span class="k">else</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="verify_error_code"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.verify_error_code">[docs]</a><span class="k">def</span> <span class="nf">verify_error_code</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make sure an error code is properly set.</span>
<span class="sd">    This makes sure that job.piloterrorcode is always set for a failed/holding job, that not only</span>
<span class="sd">    job.piloterrorcodes are set but not job.piloterrorcode. This function also negates the sign of the error code</span>
<span class="sd">    and sets job state &#39;holding&#39; (instead of &#39;failed&#39;) if the error is found to be recoverable by a later job (user</span>
<span class="sd">    jobs only).</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcode</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">piloterrorcodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;piloterrorcode set to first piloterrorcodes list entry: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">piloterrorcodes</span><span class="p">))</span>
        <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcode</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">is_analysis</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">errors</span><span class="o">.</span><span class="n">is_recoverable</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">piloterrorcode</span><span class="p">):</span>
            <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcode</span> <span class="o">=</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">piloterrorcode</span><span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;failed&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;failed user job is recoverable (error code=</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;failed user job is not recoverable&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;verified error code&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_proper_state"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.get_proper_state">[docs]</a><span class="k">def</span> <span class="nf">get_proper_state</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a proper job state to send to server.</span>
<span class="sd">    This function should only return &#39;starting&#39;, &#39;running&#39;, &#39;finished&#39;, &#39;holding&#39; or &#39;failed&#39;.</span>
<span class="sd">    If the internal job.serverstate is not yet set, it means it is the first server update, ie &#39;starting&#39; should be</span>
<span class="sd">    sent.</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :param state: internal pilot state (string).</span>
<span class="sd">    :return: valid server state (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;state=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">state</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;serverstate=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">serverstate</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">serverstate</span> <span class="o">==</span> <span class="s2">&quot;finished&quot;</span> <span class="ow">or</span> <span class="n">job</span><span class="o">.</span><span class="n">serverstate</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">job</span><span class="o">.</span><span class="n">serverstate</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">state</span> <span class="o">!=</span> <span class="s2">&quot;finished&quot;</span> <span class="ow">and</span> <span class="n">state</span> <span class="o">!=</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
        <span class="n">job</span><span class="o">.</span><span class="n">serverstate</span> <span class="o">=</span> <span class="s1">&#39;starting&#39;</span>
    <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;finished&quot;</span> <span class="ow">or</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span> <span class="ow">or</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;holding&quot;</span><span class="p">:</span>
        <span class="n">job</span><span class="o">.</span><span class="n">serverstate</span> <span class="o">=</span> <span class="n">state</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">job</span><span class="o">.</span><span class="n">serverstate</span> <span class="o">=</span> <span class="s1">&#39;running&#39;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;serverstate=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">serverstate</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">job</span><span class="o">.</span><span class="n">serverstate</span></div>


<div class="viewcode-block" id="publish_harvester_reports"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.publish_harvester_reports">[docs]</a><span class="k">def</span> <span class="nf">publish_harvester_reports</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">final</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Publish all reports needed by Harvester.</span>

<span class="sd">    :param state: job state (string).</span>
<span class="sd">    :param args: pilot args object.</span>
<span class="sd">    :param data: data structure for server update (dictionary).</span>
<span class="sd">    :param job: job object.</span>
<span class="sd">    :param final: is this the final update? (Boolean).</span>
<span class="sd">    :return: True if successful, False otherwise (Boolean).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># write part of the heartbeat message to worker attributes files needed by Harvester</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">get_worker_attributes_file</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="c1"># add jobStatus (state) for Harvester</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;jobStatus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>

    <span class="c1"># publish work report</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">publish_work_report</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;failed to write to workerAttributesFile </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># check if we are in final state then write out information for output files</span>
    <span class="k">if</span> <span class="n">final</span><span class="p">:</span>
        <span class="c1"># Use the job information to write Harvester event_status.dump file</span>
        <span class="n">event_status_file</span> <span class="o">=</span> <span class="n">get_event_status_file</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">publish_stageout_files</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">event_status_file</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;wrote log and output files to file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">event_status_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;could not write log and output files to file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">event_status_file</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># publish job report</span>
        <span class="n">_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">Payload</span><span class="o">.</span><span class="n">jobreport</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">publish_job_report</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">Payload</span><span class="o">.</span><span class="n">jobreport</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;wrote job report file&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;failed to write job report file&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;finished writing various report files in Harvester mode&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="write_heartbeat_to_file"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.write_heartbeat_to_file">[docs]</a><span class="k">def</span> <span class="nf">write_heartbeat_to_file</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write heartbeat dictionary to file.</span>
<span class="sd">    This is only done when server updates are not wanted.</span>

<span class="sd">    :param data: server data (dictionary).</span>
<span class="sd">    :return: True if successful, False otherwise (Boolean).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PILOT_HOME&#39;</span><span class="p">),</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">heartbeat_message</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">write_json</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;heartbeat dictionary: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;wrote heartbeat to file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="send_state"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.send_state">[docs]</a><span class="k">def</span> <span class="nf">send_state</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">xml</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the server (send heartbeat message).</span>
<span class="sd">    Interpret and handle any server instructions arriving with the updateJob back channel.</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :param args: Pilot arguments (e.g. containing queue name, queuedata dictionary, etc).</span>
<span class="sd">    :param state: job state (string).</span>
<span class="sd">    :param xml: optional metadata xml (string).</span>
<span class="sd">    :param metadata: job report metadata read as a string.</span>
<span class="sd">    :return: boolean (True if successful, False otherwise).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">state</span> <span class="o">=</span> <span class="n">get_proper_state</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>

    <span class="c1"># should the pilot make any server updates?</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">update_server</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pilot will not update the server (heartbeat message will be written to file)&#39;</span><span class="p">)</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s1">&#39;sending&#39;</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">update_server</span> <span class="k">else</span> <span class="s1">&#39;writing&#39;</span>

    <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;finished&#39;</span> <span class="ow">or</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;failed&#39;</span> <span class="ow">or</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;holding&#39;</span><span class="p">:</span>
        <span class="n">final</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SERVER_UPDATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SERVER_UPDATE_UPDATING</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;job </span><span class="si">%s</span><span class="s1"> has </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1"> final server update&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>

        <span class="c1"># make sure that job.state is &#39;failed&#39; if there&#39;s a set error code</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcode</span> <span class="ow">or</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcodes</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;making sure that job.state is set to failed since a pilot error code is set&#39;</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;failed&#39;</span>
            <span class="n">job</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="c1"># make sure an error code is properly set</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">!=</span> <span class="s1">&#39;finished&#39;</span><span class="p">:</span>
            <span class="n">verify_error_code</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">final</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;job </span><span class="si">%s</span><span class="s1"> has state </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1"> - </span><span class="si">%s</span><span class="s1"> heartbeat&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">tag</span><span class="p">))</span>

    <span class="c1"># build the data structure needed for getJob, updateJob</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_data_structure</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">xml</span><span class="o">=</span><span class="n">xml</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

    <span class="c1"># write the heartbeat message to file if the server is not to be updated by the pilot (Nordugrid mode)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">update_server</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;is_harvester_mode(args) : </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">is_harvester_mode</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
        <span class="c1"># if in harvester mode write to files required by harvester</span>
        <span class="k">if</span> <span class="n">is_harvester_mode</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">publish_harvester_reports</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">final</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># store the file in the main workdir</span>
            <span class="k">return</span> <span class="n">write_heartbeat_to_file</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">pandajob</span> <span class="o">==</span> <span class="s1">&#39;real&#39;</span><span class="p">:</span>
            <span class="n">time_before</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
            <span class="n">max_attempts</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="n">attempt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">while</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">max_attempts</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;job update attempt </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_attempts</span><span class="p">))</span>

                <span class="c1"># get the URL for the PanDA server from pilot options or from config</span>
                <span class="n">pandaserver</span> <span class="o">=</span> <span class="n">get_panda_server</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>

                <span class="n">res</span> <span class="o">=</span> <span class="n">https</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{pandaserver}</span><span class="s1">/server/panda/updateJob&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pandaserver</span><span class="o">=</span><span class="n">pandaserver</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">attempt</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">time_after</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;server updateJob request completed in </span><span class="si">%d</span><span class="s1">s for job </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time_after</span> <span class="o">-</span> <span class="n">time_before</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;server responded with: res = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>

            <span class="n">show_memory_usage</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># does the server update contain any backchannel information? if so, update the job object</span>
                <span class="n">handle_backchannel_command</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">final</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SERVER_UPDATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SERVER_UPDATE_FINAL</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;set SERVER_UPDATE=SERVER_UPDATE_FINAL&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;skipping job update for fake test job&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;exception caught while sending https request: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;possibly offending data: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">final</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SERVER_UPDATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SERVER_UPDATE_TROUBLE</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;set SERVER_UPDATE=SERVER_UPDATE_TROUBLE&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="get_job_status_from_server"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.get_job_status_from_server">[docs]</a><span class="k">def</span> <span class="nf">get_job_status_from_server</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the current status of job &lt;jobId&gt; from the dispatcher.</span>
<span class="sd">    typical dispatcher response: &#39;status=finished&amp;StatusCode=0&#39;</span>
<span class="sd">    StatusCode  0: succeeded</span>
<span class="sd">               10: time-out</span>
<span class="sd">               20: general error</span>
<span class="sd">               30: failed</span>
<span class="sd">    In the case of time-out, the dispatcher will be asked one more time after 10 s.</span>

<span class="sd">    :param job_id: PanDA job id (int).</span>
<span class="sd">    :param url: PanDA server URL (string).</span>
<span class="sd">    :param port: PanDA server port (int).</span>
<span class="sd">    :return: status (string; e.g. holding), attempt_nr (int), status_code (int)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
    <span class="n">attempt_nr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">status_code</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">pandajob</span> <span class="o">==</span> <span class="s1">&#39;fake&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">attempt_nr</span><span class="p">,</span> <span class="n">status_code</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_id</span>

    <span class="c1"># get the URL for the PanDA server from pilot options or from config</span>
    <span class="n">pandaserver</span> <span class="o">=</span> <span class="n">get_panda_server</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

    <span class="c1"># ask dispatcher about lost job status</span>
    <span class="n">trial</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">max_trials</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">while</span> <span class="n">trial</span> <span class="o">&lt;=</span> <span class="n">max_trials</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># open connection</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">https</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{pandaserver}</span><span class="s1">/server/panda/getStatus&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pandaserver</span><span class="o">=</span><span class="n">pandaserver</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;response: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># decode the response</span>
                    <span class="c1"># eg. var = [&#39;status=notfound&#39;, &#39;attemptNr=0&#39;, &#39;StatusCode=0&#39;]</span>
                    <span class="c1"># = response</span>

                    <span class="n">status</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>  <span class="c1"># e.g. &#39;holding&#39;</span>
                    <span class="n">attempt_nr</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;attemptNr&#39;</span><span class="p">])</span>  <span class="c1"># e.g. &#39;0&#39;</span>
                    <span class="n">status_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;StatusCode&#39;</span><span class="p">])</span>  <span class="c1"># e.g. &#39;0&#39;</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;exception: dispatcher did not return allowed values: </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ret</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
                    <span class="n">attempt_nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">status_code</span> <span class="o">=</span> <span class="mi">20</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;server job status=</span><span class="si">%s</span><span class="s1">, attempt_nr=</span><span class="si">%d</span><span class="s1">, status_code=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">attempt_nr</span><span class="p">,</span> <span class="n">status_code</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;dispatcher did not return allowed values: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
                <span class="n">attempt_nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">status_code</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;could not interpret job status from dispatcher: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
            <span class="n">attempt_nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># success</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># time-out</span>
                <span class="n">trial</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>  <span class="c1"># other error</span>
                <span class="k">if</span> <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">13056</span> <span class="ow">or</span> <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;13056&#39;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;wrong certificate used with curl operation? (encountered error 13056)&quot;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># general error</span>
                <span class="k">break</span>

    <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">attempt_nr</span><span class="p">,</span> <span class="n">status_code</span></div>


<div class="viewcode-block" id="get_panda_server"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.get_panda_server">[docs]</a><span class="k">def</span> <span class="nf">get_panda_server</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the URL for the PanDA server.</span>

<span class="sd">    :param url: URL string, if set in pilot option (port not included).</span>
<span class="sd">    :param port: port number, if set in pilot option (int).</span>
<span class="sd">    :return: full URL (either from pilot options or from config file)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">url</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">port</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">pandaserver</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pandaserver</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">pandaserver</span>

    <span class="c1"># add randomization for PanDA server</span>
    <span class="n">default</span> <span class="o">=</span> <span class="s1">&#39;pandaserver.cern.ch&#39;</span>
    <span class="k">if</span> <span class="n">default</span> <span class="ow">in</span> <span class="n">pandaserver</span><span class="p">:</span>
        <span class="n">rnd</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="k">for</span> <span class="n">vv</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="mi">25443</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">)])])</span>
        <span class="n">pandaserver</span> <span class="o">=</span> <span class="n">pandaserver</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">rnd</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;updated </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">pandaserver</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">pandaserver</span></div>


<div class="viewcode-block" id="handle_backchannel_command"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.handle_backchannel_command">[docs]</a><span class="k">def</span> <span class="nf">handle_backchannel_command</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Does the server update contain any backchannel information? if so, update the job object.</span>

<span class="sd">    :param res: server response (dictionary).</span>
<span class="sd">    :param job: job object.</span>
<span class="sd">    :param args: pilot args object.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s1">&#39;command&#39;</span> <span class="ow">in</span> <span class="n">res</span> <span class="ow">and</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;NULL&#39;</span><span class="p">:</span>
        <span class="c1"># look for &#39;tobekilled&#39;, &#39;softkill&#39;, &#39;debug&#39;, &#39;debugoff&#39;</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;tobekilled&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pilot received a panda server signal to kill job </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="n">time_stamp</span><span class="p">()))</span>
            <span class="n">set_pilot_state</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcodes</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrordiags</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">add_error_code</span><span class="p">(</span><span class="n">errors</span><span class="o">.</span><span class="n">PANDAKILL</span><span class="p">)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">abort_job</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;softkill&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pilot received a panda server signal to softkill job </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="n">time_stamp</span><span class="p">()))</span>
            <span class="c1"># event service kill instruction</span>
        <span class="k">elif</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;debug&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pilot received a command to turn on debug mode from the server&#39;</span><span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;debugoff&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pilot received a command to turn off debug mode from the server&#39;</span><span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;received unknown server command via backchannel: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="get_data_structure"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.get_data_structure">[docs]</a><span class="k">def</span> <span class="nf">get_data_structure</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">xml</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build the data structure needed for getJob, updateJob.</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :param state: state of the job (string).</span>
<span class="sd">    :param args:</span>
<span class="sd">    :param xml: optional XML string.</span>
<span class="sd">    :param metadata: job report metadata read as a string.</span>
<span class="sd">    :return: data structure (dictionary).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;building data structure to be sent to server with heartbeat&#39;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;jobId&#39;</span><span class="p">:</span> <span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span>
            <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">time_stamp</span><span class="p">(),</span>
            <span class="s1">&#39;siteName&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PILOT_SITENAME&#39;</span><span class="p">),</span>  <span class="c1"># args.site,</span>
            <span class="s1">&#39;node&#39;</span><span class="p">:</span> <span class="n">get_node_name</span><span class="p">()}</span>

    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;attemptNr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">attemptnr</span>

    <span class="n">schedulerid</span> <span class="o">=</span> <span class="n">get_job_scheduler_id</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">schedulerid</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;schedulerID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">schedulerid</span>

    <span class="n">pilotid</span> <span class="o">=</span> <span class="n">get_pilot_id</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">pilotid</span><span class="p">:</span>
        <span class="n">pilotversion</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PILOT_VERSION&#39;</span><span class="p">)</span>

        <span class="c1"># report the batch system job id, if available</span>
        <span class="n">batchsystem_type</span><span class="p">,</span> <span class="n">batchsystem_id</span> <span class="o">=</span> <span class="n">get_batchsystem_jobid</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">batchsystem_type</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pilotID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">|</span><span class="si">%s</span><span class="s2">|</span><span class="si">%s</span><span class="s2">|</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                              <span class="p">(</span><span class="n">pilotid</span><span class="p">,</span> <span class="n">batchsystem_type</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">version_tag</span><span class="p">,</span> <span class="n">pilotversion</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;batchID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batchsystem_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pilotID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">|</span><span class="si">%s</span><span class="s2">|</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pilotid</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">version_tag</span><span class="p">,</span> <span class="n">pilotversion</span><span class="p">)</span>

    <span class="n">starttime</span> <span class="o">=</span> <span class="n">get_postgetjob_time</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">starttime</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;startTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">starttime</span>

    <span class="n">job_metrics</span> <span class="o">=</span> <span class="n">get_job_metrics</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">job_metrics</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;jobMetrics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_metrics</span>

    <span class="k">if</span> <span class="n">xml</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;xml&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xml</span>
    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;metaData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>

    <span class="c1"># in debug mode, also send a tail of the latest log file touched by the payload</span>
    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
        <span class="n">stdout_tail</span> <span class="o">=</span> <span class="n">get_payload_log_tail</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stdout_tail</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;stdout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stdout_tail</span>

    <span class="c1"># add the core count</span>
    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">corecount</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">corecount</span> <span class="o">!=</span> <span class="s1">&#39;null&#39;</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">corecount</span> <span class="o">!=</span> <span class="s1">&#39;NULL&#39;</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;coreCount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">corecount</span>
        <span class="c1">#data[&#39;coreCount&#39;] = mean(job.corecounts) if job.corecounts else job.corecount</span>
    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">corecounts</span><span class="p">:</span>
        <span class="n">_mean</span> <span class="o">=</span> <span class="n">mean</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">corecounts</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mean actualcorecount: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">_mean</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;meanCoreCount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_mean</span>

    <span class="c1"># get the number of events, should report in heartbeat in case of preempted.</span>
    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">nevents</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nEvents&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">nevents</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;total number of processed events: </span><span class="si">%d</span><span class="s2"> (read)&quot;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">nevents</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;payload/TRF did not report the number of read events&quot;</span><span class="p">)</span>

    <span class="c1"># get the CU consumption time</span>
    <span class="n">constime</span> <span class="o">=</span> <span class="n">get_cpu_consumption_time</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">cpuconsumptiontime</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">constime</span> <span class="ow">and</span> <span class="n">constime</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;cpuConsumptionTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">constime</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;cpuConsumptionUnit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">cpuconsumptionunit</span> <span class="o">+</span> <span class="s2">&quot;+&quot;</span> <span class="o">+</span> <span class="n">get_cpu_model</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;cpuConversionFactor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">cpuconversionfactor</span>

    <span class="c1"># add memory information if available</span>
    <span class="n">add_memory_info</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">memorymonitor</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;finished&#39;</span> <span class="ow">or</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;failed&#39;</span><span class="p">:</span>
        <span class="n">add_timing_and_extracts</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">add_error_codes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="add_error_codes"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.add_error_codes">[docs]</a><span class="k">def</span> <span class="nf">add_error_codes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add error codes to data structure.</span>

<span class="sd">    :param data: data dictionary.</span>
<span class="sd">    :param job: job object.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># error codes</span>
    <span class="n">pilot_error_code</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcode</span>
    <span class="n">pilot_error_codes</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcodes</span>
    <span class="k">if</span> <span class="n">pilot_error_codes</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;pilotErrorCodes = </span><span class="si">%s</span><span class="s1"> (will report primary/first error code)&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">pilot_error_codes</span><span class="p">))</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pilotErrorCode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pilot_error_codes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pilotErrorCode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pilot_error_code</span>

    <span class="c1"># add error info</span>
    <span class="n">pilot_error_diag</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrordiag</span>
    <span class="n">pilot_error_diags</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrordiags</span>
    <span class="k">if</span> <span class="n">pilot_error_diags</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;pilotErrorDiags = </span><span class="si">%s</span><span class="s1"> (will report primary/first error diag)&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">pilot_error_diags</span><span class="p">))</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pilotErrorDiag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pilot_error_diags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pilotErrorDiag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pilot_error_diag</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;transExitCode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">transexitcode</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;exeErrorCode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">exeerrorcode</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;exeErrorDiag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">exeerrordiag</span></div>


<div class="viewcode-block" id="get_cpu_consumption_time"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.get_cpu_consumption_time">[docs]</a><span class="k">def</span> <span class="nf">get_cpu_consumption_time</span><span class="p">(</span><span class="n">cpuconsumptiontime</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the CPU consumption time.</span>
<span class="sd">    The function makes sure that the value exists and is within allowed limits (&lt; 10^9).</span>

<span class="sd">    :param cpuconsumptiontime: CPU consumption time (int/None).</span>
<span class="sd">    :return: properly set CPU consumption time (int/None).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">constime</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">constime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cpuconsumptiontime</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">constime</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">constime</span> <span class="ow">and</span> <span class="n">constime</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">**</span> <span class="mi">9</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;unrealistic cpuconsumptiontime: </span><span class="si">%d</span><span class="s2"> (reset to -1)&quot;</span> <span class="o">%</span> <span class="n">constime</span><span class="p">)</span>
        <span class="n">constime</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">constime</span></div>


<div class="viewcode-block" id="add_timing_and_extracts"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.add_timing_and_extracts">[docs]</a><span class="k">def</span> <span class="nf">add_timing_and_extracts</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add timing info and log extracts to data structure for a completed job (finished or failed) to be sent to server.</span>
<span class="sd">    Note: this function updates the data dictionary.</span>

<span class="sd">    :param data: data structure (dictionary).</span>
<span class="sd">    :param job: job object.</span>
<span class="sd">    :param state: state of the job (string).</span>
<span class="sd">    :param args: pilot args.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">time_getjob</span><span class="p">,</span> <span class="n">time_stagein</span><span class="p">,</span> <span class="n">time_payload</span><span class="p">,</span> <span class="n">time_stageout</span><span class="p">,</span> <span class="n">time_total_setup</span> <span class="o">=</span> <span class="n">timing_report</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pilotTiming&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">|</span><span class="si">%s</span><span class="s2">|</span><span class="si">%s</span><span class="s2">|</span><span class="si">%s</span><span class="s2">|</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                          <span class="p">(</span><span class="n">time_getjob</span><span class="p">,</span> <span class="n">time_stagein</span><span class="p">,</span> <span class="n">time_payload</span><span class="p">,</span> <span class="n">time_stageout</span><span class="p">,</span> <span class="n">time_total_setup</span><span class="p">)</span>

    <span class="c1"># add log extracts (for failed/holding jobs or for jobs with outbound connections)</span>
    <span class="n">extracts</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;failed&#39;</span> <span class="ow">or</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;holding&#39;</span><span class="p">:</span>
        <span class="n">pilot_user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PILOT_USER&#39;</span><span class="p">,</span> <span class="s1">&#39;generic&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;pilot.user.</span><span class="si">%s</span><span class="s1">.diagnose&#39;</span> <span class="o">%</span> <span class="n">pilot_user</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[</span><span class="n">pilot_user</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Python 2/3</span>
        <span class="n">extracts</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get_log_extracts</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extracts</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">XXXXXXXXXXXXXXXXXXXXX[begin log extracts]</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s1">XXXXXXXXXXXXXXXXXXXXX[end log extracts]&#39;</span> <span class="o">%</span> <span class="n">extracts</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;pilotLog&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extracts</span><span class="p">[:</span><span class="mi">1024</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;endTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>


<div class="viewcode-block" id="add_memory_info"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.add_memory_info">[docs]</a><span class="k">def</span> <span class="nf">add_memory_info</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add memory information (if available) to the data structure that will be sent to the server with job updates</span>
<span class="sd">    Note: this function updates the data dictionary.</span>

<span class="sd">    :param data: data structure (dictionary).</span>
<span class="sd">    :param workdir: working directory of the job (string).</span>
<span class="sd">    :param name: name of memory monitor (string).</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pilot_user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PILOT_USER&#39;</span><span class="p">,</span> <span class="s1">&#39;generic&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">utilities</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;pilot.user.</span><span class="si">%s</span><span class="s1">.utilities&#39;</span> <span class="o">%</span> <span class="n">pilot_user</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[</span><span class="n">pilot_user</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Python 2/3</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#for key in job.utilities</span>
        <span class="n">utility_node</span> <span class="o">=</span> <span class="n">utilities</span><span class="o">.</span><span class="n">get_memory_monitor_info</span><span class="p">(</span><span class="n">workdir</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">utility_node</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;memory information not available: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="get_list_of_log_files"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.get_list_of_log_files">[docs]</a><span class="k">def</span> <span class="nf">get_list_of_log_files</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list of log files produced by the payload.</span>

<span class="sd">    :return: list of log files.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">list_of_files</span> <span class="o">=</span> <span class="n">get_files</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">list_of_files</span><span class="p">:</span>  <span class="c1"># some TRFs produce logs with different naming scheme</span>
        <span class="n">list_of_files</span> <span class="o">=</span> <span class="n">get_files</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;log.*&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">list_of_files</span></div>


<div class="viewcode-block" id="get_payload_log_tail"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.get_payload_log_tail">[docs]</a><span class="k">def</span> <span class="nf">get_payload_log_tail</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the tail of the payload stdout or its latest updated log file.</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :return: tail of stdout (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">stdout_tail</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># find the latest updated log file</span>
    <span class="n">list_of_files</span> <span class="o">=</span> <span class="n">get_list_of_log_files</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">list_of_files</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;no log files were found (will use default </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">config</span><span class="o">.</span><span class="n">Payload</span><span class="o">.</span><span class="n">payloadstdout</span><span class="p">)</span>
        <span class="n">list_of_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">Payload</span><span class="o">.</span><span class="n">payloadstdout</span><span class="p">)]</span>  <span class="c1"># get_files(pattern=config.Payload.payloadstdout)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">latest_file</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">list_of_files</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;tail of file </span><span class="si">%s</span><span class="s1"> will be added to heartbeat&#39;</span> <span class="o">%</span> <span class="n">latest_file</span><span class="p">)</span>

        <span class="c1"># now get the tail of the found log file and protect against potentially large tails</span>
        <span class="n">stdout_tail</span> <span class="o">=</span> <span class="n">latest_file</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">tail</span><span class="p">(</span><span class="n">latest_file</span><span class="p">)</span>
        <span class="n">stdout_tail</span> <span class="o">=</span> <span class="n">stdout_tail</span><span class="p">[</span><span class="o">-</span><span class="mi">2048</span><span class="p">:]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;failed to get payload stdout tail: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">stdout_tail</span></div>


<div class="viewcode-block" id="validate"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.validate">[docs]</a><span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="n">queues</span><span class="p">,</span> <span class="n">traces</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    (add description)</span>

<span class="sd">    :param queues:</span>
<span class="sd">    :param traces:</span>
<span class="sd">    :param args:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">graceful_stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">queues</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">traces</span><span class="o">.</span><span class="n">pilot</span><span class="p">[</span><span class="s1">&#39;nr_jobs&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># set the environmental variable for the task id</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PanDA_TaskID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">taskid</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;processing PanDA job </span><span class="si">%s</span><span class="s1"> from task </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">taskid</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">_validate_job</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>

            <span class="c1"># Define a new parent group</span>
            <span class="n">os</span><span class="o">.</span><span class="n">setpgrp</span><span class="p">()</span>

            <span class="n">job_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">mainworkdir</span><span class="p">,</span> <span class="s1">&#39;PanDA_Pilot-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;creating job working directory: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job_dir</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">job_dir</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">job_dir</span><span class="p">,</span> <span class="mo">0o770</span><span class="p">)</span>
                <span class="n">job</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">job_dir</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;cannot create working directory: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">traces</span><span class="o">.</span><span class="n">pilot</span><span class="p">[</span><span class="s1">&#39;error_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">MKDIR</span>
                <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcodes</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrordiags</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">add_error_code</span><span class="p">(</span><span class="n">traces</span><span class="o">.</span><span class="n">pilot</span><span class="p">[</span><span class="s1">&#39;error_code&#39;</span><span class="p">])</span>
                <span class="n">job</span><span class="o">.</span><span class="n">piloterrordiag</span> <span class="o">=</span> <span class="n">e</span>
                <span class="n">put_in_queue</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">queues</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;symlinking pilot log&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="s1">&#39;../</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">pilotlog</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job_dir</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">pilotlog</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;cannot symlink pilot log: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

            <span class="c1"># store the PanDA job id for the wrapper to pick up</span>
            <span class="n">store_jobid</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">sourcedir</span><span class="p">)</span>

            <span class="n">put_in_queue</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">queues</span><span class="o">.</span><span class="n">validated_jobs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Failed to validate job=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">)</span>
            <span class="n">put_in_queue</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">queues</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">)</span>

    <span class="c1"># proceed to set the job_aborted flag?</span>
    <span class="k">if</span> <span class="n">threads_aborted</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;will proceed to set job_aborted&#39;</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">job_aborted</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;will not set job_aborted yet&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;[job] validate thread has finished&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="store_jobid"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.store_jobid">[docs]</a><span class="k">def</span> <span class="nf">store_jobid</span><span class="p">(</span><span class="n">jobid</span><span class="p">,</span> <span class="n">init_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store the PanDA job id in a file that can be picked up by the wrapper for other reporting.</span>

<span class="sd">    :param jobid: job id (int).</span>
<span class="sd">    :param init_dir: pilot init dir (string).</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">init_dir</span><span class="p">,</span> <span class="s1">&#39;pilot2&#39;</span><span class="p">),</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">jobid_file</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;pilot2/pilot2&#39;</span><span class="p">,</span> <span class="s1">&#39;pilot2&#39;</span><span class="p">)</span>  <span class="c1"># dirty fix for bad paths</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;w&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;path=</span><span class="si">%s</span><span class="s1">  mode=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
        <span class="n">write_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">jobid</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">mute</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;exception caught while trying to store job id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_data_payload"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.create_data_payload">[docs]</a><span class="k">def</span> <span class="nf">create_data_payload</span><span class="p">(</span><span class="n">queues</span><span class="p">,</span> <span class="n">traces</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    (add description)</span>

<span class="sd">    :param queues:</span>
<span class="sd">    :param traces:</span>
<span class="sd">    :param args:</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">graceful_stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">queues</span><span class="o">.</span><span class="n">validated_jobs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">indata</span><span class="p">:</span>
            <span class="c1"># if the job has input data, put the job object in the data_in queue which will trigger stage-in</span>
            <span class="n">set_pilot_state</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s1">&#39;stagein&#39;</span><span class="p">)</span>
            <span class="n">show_memory_usage</span><span class="p">()</span>
            <span class="n">put_in_queue</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">queues</span><span class="o">.</span><span class="n">data_in</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if the job does not have any input data, then pretend that stage-in has finished and put the job</span>
            <span class="c1"># in the finished_data_in queue</span>
            <span class="n">put_in_queue</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">queues</span><span class="o">.</span><span class="n">finished_data_in</span><span class="p">)</span>

        <span class="n">put_in_queue</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">queues</span><span class="o">.</span><span class="n">payloads</span><span class="p">)</span>

    <span class="c1"># proceed to set the job_aborted flag?</span>
    <span class="k">if</span> <span class="n">threads_aborted</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;will proceed to set job_aborted&#39;</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">job_aborted</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;will not set job_aborted yet&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;[job] create_data_payload thread has finished&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_task_id"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.get_task_id">[docs]</a><span class="k">def</span> <span class="nf">get_task_id</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the task id for the current job.</span>
<span class="sd">    Note: currently the implementation uses an environmental variable to store this number (PanDA_TaskID).</span>

<span class="sd">    :return: task id (string). Returns empty string in case of error.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;PanDA_TaskID&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">taskid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;PanDA_TaskID&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;PanDA_TaskID not set in environment&#39;</span><span class="p">)</span>
        <span class="n">taskid</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">return</span> <span class="n">taskid</span></div>


<div class="viewcode-block" id="get_job_label"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.get_job_label">[docs]</a><span class="k">def</span> <span class="nf">get_job_label</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a proper job label.</span>
<span class="sd">    The function returns a job label that corresponds to the actual pilot version, ie if the pilot is a development</span>
<span class="sd">    version (ptest or rc_test2) or production version (managed or user).</span>
<span class="sd">    Example: -i RC -&gt; job_label = rc_test2.</span>
<span class="sd">    NOTE: it should be enough to only use the job label, -j rc_test2 (and not specify -i RC at all).</span>

<span class="sd">    :param args: pilot args object.</span>
<span class="sd">    :return: job_label (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># PQ status</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">status</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">version_tag</span> <span class="o">==</span> <span class="s1">&#39;RC&#39;</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">job_label</span> <span class="o">==</span> <span class="s1">&#39;rc_test2&#39;</span><span class="p">:</span>
        <span class="n">job_label</span> <span class="o">=</span> <span class="s1">&#39;rc_test2&#39;</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">version_tag</span> <span class="o">==</span> <span class="s1">&#39;RC&#39;</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">job_label</span> <span class="o">==</span> <span class="s1">&#39;ptest&#39;</span><span class="p">:</span>
        <span class="n">job_label</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">job_label</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">version_tag</span> <span class="o">==</span> <span class="s1">&#39;RCM&#39;</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">job_label</span> <span class="o">==</span> <span class="s1">&#39;ptest&#39;</span><span class="p">:</span>
        <span class="n">job_label</span> <span class="o">=</span> <span class="s1">&#39;rcm_test2&#39;</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">version_tag</span> <span class="o">==</span> <span class="s1">&#39;ALRB&#39;</span><span class="p">:</span>
        <span class="n">job_label</span> <span class="o">=</span> <span class="s1">&#39;rc_alrb&#39;</span>
    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;test&#39;</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">job_label</span> <span class="o">!=</span> <span class="s1">&#39;ptest&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;PQ status set to test - will use job label / prodSourceLabel test&#39;</span><span class="p">)</span>
        <span class="n">job_label</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">job_label</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">job_label</span>

    <span class="k">return</span> <span class="n">job_label</span></div>


<div class="viewcode-block" id="get_dispatcher_dictionary"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.get_dispatcher_dictionary">[docs]</a><span class="k">def</span> <span class="nf">get_dispatcher_dictionary</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a dictionary with required fields for the dispatcher getJob operation.</span>

<span class="sd">    The dictionary should contain the following fields: siteName, computingElement (queue name),</span>
<span class="sd">    prodSourceLabel (e.g. user, test, ptest), diskSpace (available disk space for a job in MB),</span>
<span class="sd">    workingGroup, countryGroup, cpu (float), mem (float) and node (worker node name).</span>

<span class="sd">    workingGroup, countryGroup and allowOtherCountry</span>
<span class="sd">    we add a new pilot setting allowOtherCountry=True to be used in conjunction with countryGroup=us for</span>
<span class="sd">    US pilots. With these settings, the Panda server will produce the desired behaviour of dedicated X% of</span>
<span class="sd">    the resource exclusively (so long as jobs are available) to countryGroup=us jobs. When allowOtherCountry=false</span>
<span class="sd">    this maintains the behavior relied on by current users of the countryGroup mechanism -- to NOT allow</span>
<span class="sd">    the resource to be used outside the privileged group under any circumstances.</span>

<span class="sd">    :param args: arguments (e.g. containing queue name, queuedata dictionary, etc).</span>
<span class="sd">    :returns: dictionary prepared for the dispatcher getJob operation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_diskspace</span> <span class="o">=</span> <span class="n">get_disk_space</span><span class="p">(</span><span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="p">)</span>

    <span class="n">_mem</span><span class="p">,</span> <span class="n">_cpu</span><span class="p">,</span> <span class="n">_disk</span> <span class="o">=</span> <span class="n">collect_workernode_info</span><span class="p">()</span>

    <span class="n">_nodename</span> <span class="o">=</span> <span class="n">get_node_name</span><span class="p">()</span>

    <span class="c1"># override for RC dev pilots</span>
    <span class="n">job_label</span> <span class="o">=</span> <span class="n">get_job_label</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;siteName&#39;</span><span class="p">:</span> <span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">resource</span><span class="p">,</span>  <span class="c1"># next: remove redundant &#39;-r&#39; option of pilot.py</span>
        <span class="s1">&#39;computingElement&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span>
        <span class="s1">&#39;prodSourceLabel&#39;</span><span class="p">:</span> <span class="n">job_label</span><span class="p">,</span>
        <span class="s1">&#39;diskSpace&#39;</span><span class="p">:</span> <span class="n">_diskspace</span><span class="p">,</span>
        <span class="s1">&#39;workingGroup&#39;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">working_group</span><span class="p">,</span>
        <span class="s1">&#39;cpu&#39;</span><span class="p">:</span> <span class="n">_cpu</span><span class="p">,</span>
        <span class="s1">&#39;mem&#39;</span><span class="p">:</span> <span class="n">_mem</span><span class="p">,</span>
        <span class="s1">&#39;node&#39;</span><span class="p">:</span> <span class="n">_nodename</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;jobType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">jobtype</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">allow_other_country</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;allowOtherCountry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">allow_other_country</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">country_group</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;countryGroup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">country_group</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">job_label</span> <span class="o">==</span> <span class="s1">&#39;self&#39;</span><span class="p">:</span>
        <span class="n">dn</span> <span class="o">=</span> <span class="n">get_distinguished_name</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;prodUserID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dn</span>

    <span class="n">taskid</span> <span class="o">=</span> <span class="n">get_task_id</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">taskid</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">allow_same_user</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;taskID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">taskid</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;will download a new job belonging to task id: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;taskID&#39;</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">resource_type</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;resourceType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">resource_type</span>

    <span class="c1"># add harvester fields</span>
    <span class="k">if</span> <span class="s1">&#39;HARVESTER_ID&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;harvester_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HARVESTER_ID&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;HARVESTER_WORKER_ID&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;worker_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HARVESTER_WORKER_ID&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="proceed_with_getjob"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.proceed_with_getjob">[docs]</a><span class="k">def</span> <span class="nf">proceed_with_getjob</span><span class="p">(</span><span class="n">timefloor</span><span class="p">,</span> <span class="n">starttime</span><span class="p">,</span> <span class="n">jobnumber</span><span class="p">,</span> <span class="n">getjob_requests</span><span class="p">,</span> <span class="n">harvester</span><span class="p">,</span> <span class="n">verify_proxy</span><span class="p">,</span> <span class="n">traces</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Can we proceed with getjob?</span>
<span class="sd">    We may not proceed if we have run out of time (timefloor limit), if the proxy is too short, if disk space is too</span>
<span class="sd">    small or if we have already proceed enough jobs.</span>

<span class="sd">    :param timefloor: timefloor limit (s)</span>
<span class="sd">    :param starttime: start time of retrieve() (s)</span>
<span class="sd">    :param jobnumber: number of downloaded jobs</span>
<span class="sd">    :param getjob_requests: number of getjob requests</span>
<span class="sd">    :param harvester: True if Harvester is used, False otherwise. Affects the max number of getjob reads (from file).</span>
<span class="sd">    :param verify_proxy: True if the proxy should be verified. False otherwise.</span>
<span class="sd">    :param traces: traces object (to be able to propagate a proxy error all the way back to the wrapper).</span>
<span class="sd">    :return: Boolean.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># use for testing thread exceptions. the exception will be picked up by ExcThread run() and caught in job.control()</span>
    <span class="c1"># raise NoLocalSpace(&#39;testing exception from proceed_with_getjob&#39;)</span>

    <span class="c1">#timefloor = 600</span>
    <span class="n">currenttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># should the proxy be verified?</span>
    <span class="k">if</span> <span class="n">verify_proxy</span><span class="p">:</span>
        <span class="n">pilot_user</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PILOT_USER&#39;</span><span class="p">,</span> <span class="s1">&#39;generic&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">userproxy</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;pilot.user.</span><span class="si">%s</span><span class="s1">.proxy&#39;</span> <span class="o">%</span> <span class="n">pilot_user</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[</span><span class="n">pilot_user</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Python 2/3</span>

        <span class="c1"># is the proxy still valid?</span>
        <span class="n">exit_code</span><span class="p">,</span> <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">userproxy</span><span class="o">.</span><span class="n">verify_proxy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">traces</span><span class="o">.</span><span class="n">pilot</span><span class="p">[</span><span class="s1">&#39;error_code&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># careful so we don&#39;t overwrite another error code</span>
            <span class="n">traces</span><span class="o">.</span><span class="n">pilot</span><span class="p">[</span><span class="s1">&#39;error_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exit_code</span>
        <span class="k">if</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="n">errors</span><span class="o">.</span><span class="n">NOPROXY</span> <span class="ow">or</span> <span class="n">exit_code</span> <span class="o">==</span> <span class="n">errors</span><span class="o">.</span><span class="n">NOVOMSPROXY</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">diagnostics</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># is there enough local space to run a job?</span>
    <span class="n">ec</span><span class="p">,</span> <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">check_local_space</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ec</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">traces</span><span class="o">.</span><span class="n">pilot</span><span class="p">[</span><span class="s1">&#39;error_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">NOLOCALSPACE</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">maximum_getjob_requests</span> <span class="o">=</span> <span class="mi">60</span> <span class="k">if</span> <span class="n">harvester</span> <span class="k">else</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">maximum_getjob_requests</span>  <span class="c1"># 1 s apart (if harvester)</span>
    <span class="k">if</span> <span class="n">getjob_requests</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">maximum_getjob_requests</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;reached maximum number of getjob requests (</span><span class="si">%s</span><span class="s1">) -- will abort pilot&#39;</span> <span class="o">%</span>
                       <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">maximum_getjob_requests</span><span class="p">)</span>
        <span class="c1"># use singleton:</span>
        <span class="c1"># instruct the pilot to wrap up quickly</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PILOT_WRAP_UP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;QUICKLY&#39;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">timefloor</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">jobnumber</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;since timefloor is set to 0, pilot was only allowed to run one job&quot;</span><span class="p">)</span>
        <span class="c1"># use singleton:</span>
        <span class="c1"># instruct the pilot to wrap up quickly</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PILOT_WRAP_UP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;QUICKLY&#39;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">currenttime</span> <span class="o">-</span> <span class="n">starttime</span> <span class="o">&gt;</span> <span class="n">timefloor</span><span class="p">)</span> <span class="ow">and</span> <span class="n">jobnumber</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;the pilot has run out of time (timefloor=</span><span class="si">%d</span><span class="s2"> has been passed)&quot;</span> <span class="o">%</span> <span class="n">timefloor</span><span class="p">)</span>
        <span class="c1"># use singleton:</span>
        <span class="c1"># instruct the pilot to wrap up quickly</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PILOT_WRAP_UP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;QUICKLY&#39;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># timefloor not relevant for the first job</span>
    <span class="k">if</span> <span class="n">jobnumber</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;since timefloor=</span><span class="si">%d</span><span class="s1"> s and only </span><span class="si">%d</span><span class="s1"> s has passed since launch, pilot can run another job&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">timefloor</span><span class="p">,</span> <span class="n">currenttime</span> <span class="o">-</span> <span class="n">starttime</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">harvester</span> <span class="ow">and</span> <span class="n">jobnumber</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># unless it&#39;s the first job (which is preplaced in the init dir), instruct Harvester to place another job</span>
        <span class="c1"># in the init dir</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;asking Harvester for another job&#39;</span><span class="p">)</span>
        <span class="n">request_new_jobs</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SERVER_UPDATE&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">SERVER_UPDATE_UPDATING</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;still updating previous job, will not ask for a new job yet&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;SERVER_UPDATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SERVER_UPDATE_NOT_DONE</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="getjob_server_command"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.getjob_server_command">[docs]</a><span class="k">def</span> <span class="nf">getjob_server_command</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare the getJob server command.</span>

<span class="sd">    :param url: PanDA server URL (string)</span>
<span class="sd">    :param port: PanDA server port</span>
<span class="sd">    :return: full server command (URL string)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">url</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">port_pattern</span> <span class="o">=</span> <span class="s1">&#39;.:([0-9]+)&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">findall</span><span class="p">(</span><span class="n">port_pattern</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">port</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;URL already contains port: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">pandaserver</span>
    <span class="k">if</span> <span class="n">url</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s1">&#39;PanDA server url not set (either as pilot option or in config file)&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://&#39;</span> <span class="o">+</span> <span class="n">url</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;detected missing protocol in server url (added)&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{pandaserver}</span><span class="s1">/server/panda/getJob&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pandaserver</span><span class="o">=</span><span class="n">url</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_job_definition_from_file"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.get_job_definition_from_file">[docs]</a><span class="k">def</span> <span class="nf">get_job_definition_from_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">harvester</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a job definition from a pre-placed file.</span>
<span class="sd">    In Harvester mode, also remove any existing job request files since it is no longer needed/wanted.</span>

<span class="sd">    :param path: path to job definition file.</span>
<span class="sd">    :param harvester: True if Harvester is being used (determined from args.harvester), otherwise False</span>
<span class="sd">    :return: job definition dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># remove any existing Harvester job request files (silent in non-Harvester mode) and read the JSON</span>
    <span class="k">if</span> <span class="n">harvester</span><span class="p">:</span>
        <span class="n">remove_job_request_file</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_json</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">job_definition_list</span> <span class="o">=</span> <span class="n">parse_job_definition_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job_definition_list</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;no jobs were found in Harvester job definitions file: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># remove the job definition file from the original location, place a renamed copy in the pilot dir</span>
                <span class="n">new_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PILOT_HOME&#39;</span><span class="p">),</span> <span class="s1">&#39;job_definition.json&#39;</span><span class="p">)</span>
                <span class="n">copy</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>
                <span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

                <span class="c1"># note: the pilot can only handle one job at the time from Harvester</span>
                <span class="k">return</span> <span class="n">job_definition_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># old style</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">jobdatafile</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">jobdatafile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s1">&#39;encountered empty job definition file: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># this is a fatal error, no point in continuing as the file will not be replaced</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># parse response message</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">parse_qsl</span>  <span class="c1"># Python 2</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">parse_qsl</span>  <span class="c1"># Python 3</span>
            <span class="n">datalist</span> <span class="o">=</span> <span class="n">parse_qsl</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">keep_blank_values</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># convert to dictionary</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">datalist</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="get_job_definition_from_server"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.get_job_definition_from_server">[docs]</a><span class="k">def</span> <span class="nf">get_job_definition_from_server</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a job definition from a server.</span>

<span class="sd">    :param args: Pilot arguments (e.g. containing queue name, queuedata dictionary, etc).</span>
<span class="sd">    :return: job definition dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># get the job dispatcher dictionary</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_dispatcher_dictionary</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="n">getjob_server_command</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cmd</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;executing server command: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">https</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="locate_job_definition"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.locate_job_definition">[docs]</a><span class="k">def</span> <span class="nf">locate_job_definition</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Locate the job definition file among standard locations.</span>

<span class="sd">    :param args: Pilot arguments (e.g. containing queue name, queuedata dictionary, etc).</span>
<span class="sd">    :return: path (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/..&quot;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">sourcedir</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">pandajobdata</span><span class="p">),</span>
             <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">sourcedir</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">pandajobdata</span><span class="p">),</span>
             <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PILOT_WORK_DIR&#39;</span><span class="p">],</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">pandajobdata</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">harvester_workdir</span><span class="p">:</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">harvester_workdir</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">Harvester</span><span class="o">.</span><span class="n">pandajob_file</span><span class="p">))</span>
    <span class="k">if</span> <span class="s1">&#39;HARVESTER_WORKDIR&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HARVESTER_WORKDIR&#39;</span><span class="p">],</span> <span class="n">config</span><span class="o">.</span><span class="n">Harvester</span><span class="o">.</span><span class="n">pandajob_file</span><span class="p">))</span>

    <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">_path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_path</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">_path</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;did not find any local job definition file&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">path</span></div>


<div class="viewcode-block" id="get_job_definition"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.get_job_definition">[docs]</a><span class="k">def</span> <span class="nf">get_job_definition</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a job definition from a source (server or pre-placed local file).</span>

<span class="sd">    :param args: Pilot arguments (e.g. containing queue name, queuedata dictionary, etc).</span>
<span class="sd">    :return: job definition dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">locate_job_definition</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="c1"># should we run a norma &#39;real&#39; job or with a &#39;fake&#39; job?</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">pandajob</span> <span class="o">==</span> <span class="s1">&#39;fake&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;will use a fake PanDA job&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">get_fake_job</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;will read job definition from file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">get_job_definition_from_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">harvester</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">harvester</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">harvester_submitmode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;push&#39;</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># local job definition file not found (go to sleep)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;will download job definition from server&#39;</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">get_job_definition_from_server</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="get_fake_job"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.get_fake_job">[docs]</a><span class="k">def</span> <span class="nf">get_fake_job</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a job definition for internal pilot testing.</span>
<span class="sd">    Note: this function is only used for testing purposes. The job definitions below are ATLAS specific.</span>

<span class="sd">    :param input: Boolean, set to False if no input files are wanted</span>
<span class="sd">    :return: job definition (dictionary).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># create hashes</span>
    <span class="nb">hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
    <span class="nb">hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
    <span class="n">log_guid</span> <span class="o">=</span> <span class="nb">hash</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="nb">hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
    <span class="n">guid</span> <span class="o">=</span> <span class="nb">hash</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="nb">hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
    <span class="n">job_name</span> <span class="o">=</span> <span class="nb">hash</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">testjobtype</span> <span class="o">==</span> <span class="s1">&#39;production&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;creating fake test production job definition&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;jobsetID&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;logGUID&#39;</span><span class="p">:</span> <span class="n">log_guid</span><span class="p">,</span>
               <span class="s1">&#39;cmtConfig&#39;</span><span class="p">:</span> <span class="s1">&#39;x86_64-slc6-gcc48-opt&#39;</span><span class="p">,</span>
               <span class="s1">&#39;prodDBlocks&#39;</span><span class="p">:</span> <span class="s1">&#39;user.mlassnig:user.mlassnig.pilot.test.single.hits&#39;</span><span class="p">,</span>
               <span class="s1">&#39;dispatchDBlockTokenForOut&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL,NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;destinationDBlockToken&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL,NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;destinationSE&#39;</span><span class="p">:</span> <span class="s1">&#39;AGLT2_TEST&#39;</span><span class="p">,</span>
               <span class="s1">&#39;realDatasets&#39;</span><span class="p">:</span> <span class="n">job_name</span><span class="p">,</span>
               <span class="s1">&#39;prodUserID&#39;</span><span class="p">:</span> <span class="s1">&#39;no_one&#39;</span><span class="p">,</span>
               <span class="s1">&#39;GUID&#39;</span><span class="p">:</span> <span class="n">guid</span><span class="p">,</span>
               <span class="s1">&#39;realDatasetsIn&#39;</span><span class="p">:</span> <span class="s1">&#39;user.mlassnig:user.mlassnig.pilot.test.single.hits&#39;</span><span class="p">,</span>
               <span class="s1">&#39;nSent&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
               <span class="s1">&#39;cloud&#39;</span><span class="p">:</span> <span class="s1">&#39;US&#39;</span><span class="p">,</span>
               <span class="s1">&#39;StatusCode&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
               <span class="s1">&#39;homepackage&#39;</span><span class="p">:</span> <span class="s1">&#39;AtlasProduction/20.1.4.14&#39;</span><span class="p">,</span>
               <span class="s1">&#39;inFiles&#39;</span><span class="p">:</span> <span class="s1">&#39;HITS.06828093._000096.pool.root.1&#39;</span><span class="p">,</span>
               <span class="s1">&#39;processingType&#39;</span><span class="p">:</span> <span class="s1">&#39;pilot-ptest&#39;</span><span class="p">,</span>
               <span class="s1">&#39;ddmEndPointOut&#39;</span><span class="p">:</span> <span class="s1">&#39;UTA_SWT2_DATADISK,UTA_SWT2_DATADISK&#39;</span><span class="p">,</span>
               <span class="s1">&#39;fsize&#39;</span><span class="p">:</span> <span class="s1">&#39;94834717&#39;</span><span class="p">,</span>
               <span class="s1">&#39;fileDestinationSE&#39;</span><span class="p">:</span> <span class="s1">&#39;AGLT2_TEST,AGLT2_TEST&#39;</span><span class="p">,</span>
               <span class="s1">&#39;scopeOut&#39;</span><span class="p">:</span> <span class="s1">&#39;panda&#39;</span><span class="p">,</span>
               <span class="s1">&#39;minRamCount&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
               <span class="s1">&#39;jobDefinitionID&#39;</span><span class="p">:</span> <span class="mi">7932</span><span class="p">,</span>
               <span class="s1">&#39;maxWalltime&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;scopeLog&#39;</span><span class="p">:</span> <span class="s1">&#39;panda&#39;</span><span class="p">,</span>
               <span class="s1">&#39;transformation&#39;</span><span class="p">:</span> <span class="s1">&#39;Reco_tf.py&#39;</span><span class="p">,</span>
               <span class="s1">&#39;maxDiskCount&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
               <span class="s1">&#39;coreCount&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
               <span class="s1">&#39;prodDBlockToken&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;transferType&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;destinationDblock&#39;</span><span class="p">:</span> <span class="n">job_name</span><span class="p">,</span>
               <span class="s1">&#39;dispatchDBlockToken&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;jobPars&#39;</span><span class="p">:</span> <span class="s1">&#39;--maxEvents=1 --inputHITSFile HITS.06828093._000096.pool.root.1 --outputRDOFile RDO_</span><span class="si">%s</span><span class="s1">.root&#39;</span> <span class="o">%</span> <span class="n">job_name</span><span class="p">,</span>
               <span class="s1">&#39;attemptNr&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
               <span class="s1">&#39;swRelease&#39;</span><span class="p">:</span> <span class="s1">&#39;Atlas-20.1.4&#39;</span><span class="p">,</span>
               <span class="s1">&#39;nucleus&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;maxCpuCount&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
               <span class="s1">&#39;outFiles&#39;</span><span class="p">:</span> <span class="s1">&#39;RDO_</span><span class="si">%s</span><span class="s1">.root,</span><span class="si">%s</span><span class="s1">.job.log.tgz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job_name</span><span class="p">,</span> <span class="n">job_name</span><span class="p">),</span>
               <span class="s1">&#39;currentPriority&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
               <span class="s1">&#39;scopeIn&#39;</span><span class="p">:</span> <span class="s1">&#39;mc15_13TeV&#39;</span><span class="p">,</span>
               <span class="s1">&#39;PandaID&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
               <span class="s1">&#39;sourceSite&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;dispatchDblock&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;prodSourceLabel&#39;</span><span class="p">:</span> <span class="s1">&#39;ptest&#39;</span><span class="p">,</span>
               <span class="s1">&#39;checksum&#39;</span><span class="p">:</span> <span class="s1">&#39;ad:5d000974&#39;</span><span class="p">,</span>
               <span class="s1">&#39;jobName&#39;</span><span class="p">:</span> <span class="n">job_name</span><span class="p">,</span>
               <span class="s1">&#39;ddmEndPointIn&#39;</span><span class="p">:</span> <span class="s1">&#39;UTA_SWT2_DATADISK&#39;</span><span class="p">,</span>
               <span class="s1">&#39;taskID&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;logFile&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.job.log.tgz&#39;</span> <span class="o">%</span> <span class="n">job_name</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">testjobtype</span> <span class="o">==</span> <span class="s1">&#39;user&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;creating fake test user job definition&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;jobsetID&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;logGUID&#39;</span><span class="p">:</span> <span class="n">log_guid</span><span class="p">,</span>
               <span class="s1">&#39;cmtConfig&#39;</span><span class="p">:</span> <span class="s1">&#39;x86_64-slc6-gcc49-opt&#39;</span><span class="p">,</span>
               <span class="s1">&#39;prodDBlocks&#39;</span><span class="p">:</span> <span class="s1">&#39;data15_13TeV:data15_13TeV.00276336.physics_Main.merge.AOD.r7562_p2521_tid07709524_00&#39;</span><span class="p">,</span>
               <span class="s1">&#39;dispatchDBlockTokenForOut&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL,NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;destinationDBlockToken&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL,NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;destinationSE&#39;</span><span class="p">:</span> <span class="s1">&#39;ANALY_SWT2_CPB&#39;</span><span class="p">,</span>
               <span class="s1">&#39;realDatasets&#39;</span><span class="p">:</span> <span class="n">job_name</span><span class="p">,</span>
               <span class="s1">&#39;prodUserID&#39;</span><span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span>
               <span class="s1">&#39;GUID&#39;</span><span class="p">:</span> <span class="n">guid</span><span class="p">,</span>
               <span class="s1">&#39;realDatasetsIn&#39;</span><span class="p">:</span> <span class="s1">&#39;data15_13TeV:data15_13TeV.00276336.physics_Main.merge.AOD.r7562_p2521_tid07709524_00&#39;</span><span class="p">,</span>
               <span class="s1">&#39;nSent&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
               <span class="s1">&#39;cloud&#39;</span><span class="p">:</span> <span class="s1">&#39;US&#39;</span><span class="p">,</span>
               <span class="s1">&#39;StatusCode&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
               <span class="s1">&#39;homepackage&#39;</span><span class="p">:</span> <span class="s1">&#39;AnalysisTransforms-AtlasDerivation_20.7.6.4&#39;</span><span class="p">,</span>
               <span class="s1">&#39;inFiles&#39;</span><span class="p">:</span> <span class="s1">&#39;AOD.07709524._000050.pool.root.1&#39;</span><span class="p">,</span>
               <span class="s1">&#39;processingType&#39;</span><span class="p">:</span> <span class="s1">&#39;pilot-ptest&#39;</span><span class="p">,</span>
               <span class="s1">&#39;ddmEndPointOut&#39;</span><span class="p">:</span> <span class="s1">&#39;SWT2_CPB_SCRATCHDISK,SWT2_CPB_SCRATCHDISK&#39;</span><span class="p">,</span>
               <span class="s1">&#39;fsize&#39;</span><span class="p">:</span> <span class="s1">&#39;1564780952&#39;</span><span class="p">,</span>
               <span class="s1">&#39;fileDestinationSE&#39;</span><span class="p">:</span> <span class="s1">&#39;ANALY_SWT2_CPB,ANALY_SWT2_CPB&#39;</span><span class="p">,</span>
               <span class="s1">&#39;scopeOut&#39;</span><span class="p">:</span> <span class="s1">&#39;user.gangarbt&#39;</span><span class="p">,</span>
               <span class="s1">&#39;minRamCount&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
               <span class="s1">&#39;jobDefinitionID&#39;</span><span class="p">:</span> <span class="s1">&#39;9445&#39;</span><span class="p">,</span>
               <span class="s1">&#39;maxWalltime&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;scopeLog&#39;</span><span class="p">:</span> <span class="s1">&#39;user.gangarbt&#39;</span><span class="p">,</span>
               <span class="s1">&#39;transformation&#39;</span><span class="p">:</span> <span class="s1">&#39;http://pandaserver.cern.ch:25080/trf/user/runAthena-00-00-11&#39;</span><span class="p">,</span>
               <span class="s1">&#39;maxDiskCount&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
               <span class="s1">&#39;coreCount&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
               <span class="s1">&#39;prodDBlockToken&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;transferType&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;destinationDblock&#39;</span><span class="p">:</span> <span class="n">job_name</span><span class="p">,</span>
               <span class="s1">&#39;dispatchDBlockToken&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;jobPars&#39;</span><span class="p">:</span> <span class="s1">&#39;-a sources.20115461.derivation.tgz -r ./ -j &quot;Reco_tf.py &#39;</span>
                           <span class="s1">&#39;--inputAODFile AOD.07709524._000050.pool.root.1 --outputDAODFile test.pool.root &#39;</span>
                           <span class="s1">&#39;--reductionConf HIGG3D1&quot; -i &quot;[</span><span class="se">\&#39;</span><span class="s1">AOD.07709524._000050.pool.root.1</span><span class="se">\&#39;</span><span class="s1">]&quot; -m &quot;[]&quot; -n &quot;[]&quot; --trf&#39;</span>
                           <span class="s1">&#39; --useLocalIO --accessmode=copy -o &#39;</span>
                           <span class="s1">&#39;&quot;{</span><span class="se">\&#39;</span><span class="s1">IROOT</span><span class="se">\&#39;</span><span class="s1">: [(</span><span class="se">\&#39;</span><span class="s1">DAOD_HIGG3D1.test.pool.root</span><span class="se">\&#39;</span><span class="s1">, </span><span class="se">\&#39;</span><span class="si">%s</span><span class="s1">.root</span><span class="se">\&#39;</span><span class="s1">)]}&quot; &#39;</span>
                           <span class="s1">&#39;--sourceURL https://aipanda012.cern.ch:25443&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job_name</span><span class="p">),</span>
               <span class="s1">&#39;attemptNr&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
               <span class="s1">&#39;swRelease&#39;</span><span class="p">:</span> <span class="s1">&#39;Atlas-20.7.6&#39;</span><span class="p">,</span>
               <span class="s1">&#39;nucleus&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;maxCpuCount&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
               <span class="s1">&#39;outFiles&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.root,</span><span class="si">%s</span><span class="s1">.job.log.tgz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job_name</span><span class="p">,</span> <span class="n">job_name</span><span class="p">),</span>
               <span class="s1">&#39;currentPriority&#39;</span><span class="p">:</span> <span class="s1">&#39;1000&#39;</span><span class="p">,</span>
               <span class="s1">&#39;scopeIn&#39;</span><span class="p">:</span> <span class="s1">&#39;data15_13TeV&#39;</span><span class="p">,</span>
               <span class="s1">&#39;PandaID&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
               <span class="s1">&#39;sourceSite&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;dispatchDblock&#39;</span><span class="p">:</span> <span class="s1">&#39;data15_13TeV:data15_13TeV.00276336.physics_Main.merge.AOD.r7562_p2521_tid07709524_00&#39;</span><span class="p">,</span>
               <span class="s1">&#39;prodSourceLabel&#39;</span><span class="p">:</span> <span class="s1">&#39;ptest&#39;</span><span class="p">,</span>
               <span class="s1">&#39;checksum&#39;</span><span class="p">:</span> <span class="s1">&#39;ad:b11f45a7&#39;</span><span class="p">,</span>
               <span class="s1">&#39;jobName&#39;</span><span class="p">:</span> <span class="n">job_name</span><span class="p">,</span>
               <span class="s1">&#39;ddmEndPointIn&#39;</span><span class="p">:</span> <span class="s1">&#39;SWT2_CPB_SCRATCHDISK&#39;</span><span class="p">,</span>
               <span class="s1">&#39;taskID&#39;</span><span class="p">:</span> <span class="s1">&#39;NULL&#39;</span><span class="p">,</span>
               <span class="s1">&#39;logFile&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.job.log.tgz&#39;</span> <span class="o">%</span> <span class="n">job_name</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;unknown test job type: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">testjobtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">input</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;inFiles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;GUID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;scopeIn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;fsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;realDatasetsIn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;checksum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NULL&#39;</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">testtransfertype</span> <span class="o">==</span> <span class="s2">&quot;NULL&quot;</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">testtransfertype</span> <span class="o">==</span> <span class="s1">&#39;direct&#39;</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;transferType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">testtransfertype</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;unknown test transfer type: </span><span class="si">%s</span><span class="s1"> (ignored)&#39;</span> <span class="o">%</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">testtransfertype</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">testjobcommand</span> <span class="o">==</span> <span class="s1">&#39;sleep&#39;</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;transformation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sleep&#39;</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;jobPars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;inFiles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;outFiles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># convert to unicode for Python 2</span>
        <span class="k">try</span><span class="p">:</span>  <span class="c1"># in case some later version of Python 3 has problems using u&#39;&#39; (seems ok with 3.7 at least)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_python3</span><span class="p">():</span>
                <span class="n">_res</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">entry</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                        <span class="n">_res</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">res</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_res</span><span class="p">[</span><span class="sa">u</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">entry</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">entry</span><span class="p">]</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">_res</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">res</span></div>


<div class="viewcode-block" id="get_job_retrieval_delay"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.get_job_retrieval_delay">[docs]</a><span class="k">def</span> <span class="nf">get_job_retrieval_delay</span><span class="p">(</span><span class="n">harvester</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the proper delay between job retrieval attempts.</span>
<span class="sd">    In Harvester mode, the pilot will look once per second for a job definition file.</span>

<span class="sd">    :param harvester: True if Harvester is being used (determined from args.harvester), otherwise False</span>
<span class="sd">    :return: sleep (s)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">harvester</span> <span class="k">else</span> <span class="mi">60</span></div>


<div class="viewcode-block" id="retrieve"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.retrieve">[docs]</a><span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="n">queues</span><span class="p">,</span> <span class="n">traces</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>  <span class="c1"># noqa: C901</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve all jobs from a source.</span>

<span class="sd">    The job definition is a json dictionary that is either present in the launch</span>
<span class="sd">    directory (preplaced) or downloaded from a server specified by `args.url`.</span>

<span class="sd">    The function retrieves the job definition from the proper source and places</span>
<span class="sd">    it in the `queues.jobs` queue.</span>

<span class="sd">    WARNING: this function is nearly too complex. Be careful with adding more lines as flake8 will fail it.</span>

<span class="sd">    :param queues: internal queues for job handling.</span>
<span class="sd">    :param traces: tuple containing internal pilot states.</span>
<span class="sd">    :param args: Pilot arguments (e.g. containing queue name, queuedata dictionary, etc).</span>
<span class="sd">    :raises PilotException: if create_job fails (e.g. because queuedata could not be downloaded).</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">timefloor</span> <span class="o">=</span> <span class="n">infosys</span><span class="o">.</span><span class="n">queuedata</span><span class="o">.</span><span class="n">timefloor</span>
    <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">jobnumber</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># number of downloaded jobs</span>
    <span class="n">getjob_requests</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># number of getjob requests</span>

    <span class="n">print_node_info</span><span class="p">()</span>

    <span class="k">while</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">graceful_stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">getjob_requests</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">proceed_with_getjob</span><span class="p">(</span><span class="n">timefloor</span><span class="p">,</span> <span class="n">starttime</span><span class="p">,</span> <span class="n">jobnumber</span><span class="p">,</span> <span class="n">getjob_requests</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">harvester</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">verify_proxy</span><span class="p">,</span> <span class="n">traces</span><span class="p">):</span>
            <span class="c1"># do not set graceful stop if pilot has not finished sending the final job update</span>
            <span class="c1"># i.e. wait until SERVER_UPDATE is DONE_FINAL</span>
            <span class="n">check_for_final_server_update</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">update_server</span><span class="p">)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">graceful_stop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">break</span>

        <span class="c1"># store time stamp</span>
        <span class="n">time_pre_getjob</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># get a job definition from a source (file or server)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">get_job_definition</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;job definition = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s1">&#39;fatal error in job download loop - cannot continue&#39;</span><span class="p">)</span>
            <span class="c1"># do not set graceful stop if pilot has not finished sending the final job update</span>
            <span class="c1"># i.e. wait until SERVER_UPDATE is DONE_FINAL</span>
            <span class="n">check_for_final_server_update</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">update_server</span><span class="p">)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">graceful_stop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="n">get_job_retrieval_delay</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">harvester</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">harvester</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;did not get a job -- sleep </span><span class="si">%d</span><span class="s1"> s and repeat&#39;</span> <span class="o">%</span> <span class="n">delay</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">delay</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">graceful_stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="k">break</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># it seems the PanDA server returns StatusCode as an int, but the aCT returns it as a string</span>
            <span class="c1"># note: StatusCode keyword is not available in job definition files from Harvester (not needed)</span>
            <span class="k">if</span> <span class="s1">&#39;StatusCode&#39;</span> <span class="ow">in</span> <span class="n">res</span> <span class="ow">and</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;StatusCode&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;0&#39;</span> <span class="ow">and</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;StatusCode&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;did not get a job -- sleep 60s and repeat -- status: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;StatusCode&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">graceful_stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                        <span class="k">break</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># create the job object out of the raw dispatcher job dictionary</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">show_memory_usage</span><span class="p">()</span>
                    <span class="n">job</span> <span class="o">=</span> <span class="n">create_job</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">PilotException</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">error</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">show_memory_usage</span><span class="p">()</span>
                    <span class="c1"># verify the job status on the server</span>
                    <span class="c1">#try:</span>
                    <span class="c1">#    job_status, job_attempt_nr, job_status_code = get_job_status_from_server(job.jobid, args.url, args.port)</span>
                    <span class="c1">#    if job_status == &quot;running&quot;:</span>
                    <span class="c1">#        pilot_error_diag = &quot;job %s is already running elsewhere - aborting&quot; % (job.jobid)</span>
                    <span class="c1">#        logger.warning(pilot_error_diag)</span>
                    <span class="c1">#        raise JobAlreadyRunning(pilot_error_diag)</span>
                    <span class="c1">#except Exception as e:</span>
                    <span class="c1">#    logger.warning(&quot;%s&quot; % e)</span>
                <span class="c1"># write time stamps to pilot timing file</span>
                <span class="c1"># note: PILOT_POST_GETJOB corresponds to START_TIME in Pilot 1</span>
                <span class="n">add_to_pilot_timing</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="n">PILOT_PRE_GETJOB</span><span class="p">,</span> <span class="n">time_pre_getjob</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="n">add_to_pilot_timing</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="n">PILOT_POST_GETJOB</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">args</span><span class="p">)</span>

                <span class="c1"># add the job definition to the jobs queue and increase the job counter,</span>
                <span class="c1"># and wait until the job has finished</span>
                <span class="n">put_in_queue</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">queues</span><span class="o">.</span><span class="n">jobs</span><span class="p">)</span>

                <span class="n">jobnumber</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">graceful_stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">has_job_completed</span><span class="p">(</span><span class="n">queues</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
                        <span class="c1">#import signal</span>
                        <span class="c1">#os.kill(os.getpid(), signal.SIGTERM)</span>

                        <span class="n">args</span><span class="o">.</span><span class="n">job_aborted</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                        <span class="n">args</span><span class="o">.</span><span class="n">abort_job</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ready for new job&#39;</span><span class="p">)</span>

                        <span class="c1"># re-establish logging</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pilot has finished for previous job - re-establishing logging&#39;</span><span class="p">)</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                        <span class="n">establish_logging</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                        <span class="n">pilot_version_banner</span><span class="p">()</span>
                        <span class="n">getjob_requests</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">add_to_pilot_timing</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">PILOT_MULTIJOB_START_TIME</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">args</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># proceed to set the job_aborted flag?</span>
    <span class="k">if</span> <span class="n">threads_aborted</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;will proceed to set job_aborted&#39;</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">job_aborted</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;will not set job_aborted yet&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;[job] retrieve thread has finished&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="print_node_info"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.print_node_info">[docs]</a><span class="k">def</span> <span class="nf">print_node_info</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print information about the local node to the log.</span>

<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">is_virtual_machine</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;pilot is running in a virtual machine&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;pilot is not running in a virtual machine&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_job"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.create_job">[docs]</a><span class="k">def</span> <span class="nf">create_job</span><span class="p">(</span><span class="n">dispatcher_response</span><span class="p">,</span> <span class="n">queue</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a job object out of the dispatcher response.</span>

<span class="sd">    :param dispatcher_response: raw job dictionary from the dispatcher.</span>
<span class="sd">    :param queue: queue name (string).</span>
<span class="sd">    :return: job object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># initialize (job specific) InfoService instance</span>

    <span class="n">job</span> <span class="o">=</span> <span class="n">JobData</span><span class="p">(</span><span class="n">dispatcher_response</span><span class="p">)</span>

    <span class="n">jobinfosys</span> <span class="o">=</span> <span class="n">InfoService</span><span class="p">()</span>
    <span class="n">jobinfosys</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">infosys</span><span class="o">.</span><span class="n">confinfo</span><span class="p">,</span> <span class="n">infosys</span><span class="o">.</span><span class="n">extinfo</span><span class="p">,</span> <span class="n">JobInfoProvider</span><span class="p">(</span><span class="n">job</span><span class="p">))</span>
    <span class="n">job</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">infosys</span><span class="p">)</span>

    <span class="c1">#job.workdir = os.getcwd()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;received job: </span><span class="si">%s</span><span class="s1"> (sleep until the job has finished)&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;job details: </span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="p">)</span>

    <span class="c1"># payload environment wants the PANDAID to be set, also used below</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PANDAID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">jobid</span>

    <span class="k">return</span> <span class="n">job</span></div>


<div class="viewcode-block" id="has_job_completed"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.has_job_completed">[docs]</a><span class="k">def</span> <span class="nf">has_job_completed</span><span class="p">(</span><span class="n">queues</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Has the current job completed (finished or failed)?</span>
<span class="sd">    Note: the job object was extracted from monitored_payloads queue before this function was called.</span>

<span class="sd">    :param queues: Pilot queues object.</span>
<span class="sd">    :return: True is the payload has finished or failed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check if the job has finished</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">queues</span><span class="o">.</span><span class="n">completed_jobs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
        <span class="c1"># logger.info(&quot;(job still running)&quot;)</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">make_job_report</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;ls -lF </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PILOT_HOME&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="n">ec</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>

        <span class="n">queue_report</span><span class="p">(</span><span class="n">queues</span><span class="p">)</span>
        <span class="n">job</span><span class="o">.</span><span class="n">reset_errors</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;job </span><span class="si">%s</span><span class="s2"> has completed (purged errors)&quot;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">)</span>

        <span class="c1"># cleanup of any remaining processes</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">pid</span><span class="p">:</span>
            <span class="n">job</span><span class="o">.</span><span class="n">zombies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="n">cleanup</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># is there anything in the finished_jobs queue?</span>
    <span class="c1">#finished_queue_snapshot = list(queues.finished_jobs.queue)</span>
    <span class="c1">#peek = [obj for obj in finished_queue_snapshot if jobid == obj.jobid]</span>
    <span class="c1">#if peek:</span>
    <span class="c1">#    logger.info(&quot;job %s has completed (finished)&quot; % jobid)</span>
    <span class="c1">#    return True</span>

    <span class="c1"># is there anything in the failed_jobs queue?</span>
    <span class="c1">#failed_queue_snapshot = list(queues.failed_jobs.queue)</span>
    <span class="c1">#peek = [obj for obj in failed_queue_snapshot if jobid == obj.jobid]</span>
    <span class="c1">#if peek:</span>
    <span class="c1">#    logger.info(&quot;job %s has completed (failed)&quot; % jobid)</span>
    <span class="c1">#    return True</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="get_job_from_queue"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.get_job_from_queue">[docs]</a><span class="k">def</span> <span class="nf">get_job_from_queue</span><span class="p">(</span><span class="n">queues</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the job has finished or failed and if so return it.</span>

<span class="sd">    :param queues: pilot queues.</span>
<span class="sd">    :param state: job state (e.g. finished/failed) (string).</span>
<span class="sd">    :return: job object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;finished&quot;</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">queues</span><span class="o">.</span><span class="n">finished_jobs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">queues</span><span class="o">.</span><span class="n">failed_jobs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
        <span class="c1"># logger.info(&quot;(job still running)&quot;)</span>
        <span class="n">job</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># make sure that state=failed</span>
        <span class="n">set_pilot_state</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;job </span><span class="si">%s</span><span class="s2"> has state=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">job</span></div>


<div class="viewcode-block" id="is_queue_empty"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.is_queue_empty">[docs]</a><span class="k">def</span> <span class="nf">is_queue_empty</span><span class="p">(</span><span class="n">queues</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the given queue is empty (without pulling).</span>

<span class="sd">    :param queues: pilot queues object.</span>
<span class="sd">    :param q: queue name (string).</span>
<span class="sd">    :return: True if queue is empty, False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">queues</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
        <span class="n">_q</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">queues</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_q</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;queue </span><span class="si">%s</span><span class="s1"> not empty: found </span><span class="si">%d</span><span class="s1"> job(s)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;queue </span><span class="si">%s</span><span class="s1"> is empty&#39;</span> <span class="o">%</span> <span class="n">q</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;queue </span><span class="si">%s</span><span class="s1"> not present in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">queues</span><span class="o">.</span><span class="n">_fields</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">status</span></div>


<div class="viewcode-block" id="order_log_transfer"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.order_log_transfer">[docs]</a><span class="k">def</span> <span class="nf">order_log_transfer</span><span class="p">(</span><span class="n">queues</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Order a log transfer for a failed job.</span>

<span class="sd">    :param queues: pilot queues object.</span>
<span class="sd">    :param job: job object.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># add the job object to the data_out queue to have it staged out</span>
    <span class="n">job</span><span class="o">.</span><span class="n">stageout</span> <span class="o">=</span> <span class="s1">&#39;log&#39;</span>  <span class="c1"># only stage-out log file</span>
    <span class="c1">#set_pilot_state(job=job, state=&#39;stageout&#39;)</span>
    <span class="n">put_in_queue</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">queues</span><span class="o">.</span><span class="n">data_out</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;job added to data_out queue&#39;</span><span class="p">)</span>

    <span class="c1"># wait for the log transfer to finish</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nmax</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">nmax</span><span class="p">:</span>
        <span class="c1"># refresh the log_transfer since it might have changed</span>
        <span class="n">log_transfer</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="s1">&#39;LOG_TRANSFER&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;waiting for log transfer to finish (#</span><span class="si">%d</span><span class="s1">/#</span><span class="si">%d</span><span class="s1">): </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span> <span class="n">log_transfer</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">is_queue_empty</span><span class="p">(</span><span class="n">queues</span><span class="p">,</span> <span class="s1">&#39;data_out&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="n">log_transfer</span> <span class="o">==</span> <span class="n">LOG_TRANSFER_DONE</span> <span class="ow">or</span> <span class="n">log_transfer</span> <span class="o">==</span> <span class="n">LOG_TRANSFER_FAILED</span><span class="p">):</span>  <span class="c1"># set in data component</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;stage-out of log has completed&#39;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">log_transfer</span> <span class="o">==</span> <span class="n">LOG_TRANSFER_IN_PROGRESS</span><span class="p">:</span>  <span class="c1"># set in data component, job object is singleton</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;log transfer is in progress&#39;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;proceeding with server update (n=</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span></div>


<div class="viewcode-block" id="wait_for_aborted_job_stageout"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.wait_for_aborted_job_stageout">[docs]</a><span class="k">def</span> <span class="nf">wait_for_aborted_job_stageout</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">queues</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wait for stage-out to finish for aborted job.</span>

<span class="sd">    :param args: pilot args object.</span>
<span class="sd">    :param queues: pilot queues object.</span>
<span class="sd">    :param job: job object.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if the pilot received a kill signal, how much time has passed since the signal was intercepted?</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">time_since_kill</span> <span class="o">=</span> <span class="n">get_time_since</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">PILOT_KILL_SIGNAL</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">was_killed</span> <span class="o">=</span> <span class="n">was_pilot_killed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">timing</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">was_killed</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> s passed since kill signal was intercepted - make sure that stage-out has finished&#39;</span> <span class="o">%</span> <span class="n">time_since_kill</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;exception caught: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">time_since_kill</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">time_since_kill</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="ow">or</span> <span class="n">time_since_kill</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># fail-safe</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;reset time_since_kill to 60 since value is out of allowed limits&#39;</span><span class="p">)</span>
            <span class="n">time_since_kill</span> <span class="o">=</span> <span class="mi">60</span>

    <span class="c1"># if stage-out has not finished, we need to wait (less than two minutes or the batch system will issue</span>
    <span class="c1"># a hard SIGKILL)</span>
    <span class="n">max_wait_time</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">-</span> <span class="n">time_since_kill</span> <span class="o">-</span> <span class="mi">5</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;using max_wait_time = </span><span class="si">%d</span><span class="s1"> s&#39;</span> <span class="o">%</span> <span class="n">max_wait_time</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="n">max_wait_time</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">queues</span><span class="o">.</span><span class="n">finished_data_out</span><span class="o">.</span><span class="n">queue</span> <span class="ow">or</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">queues</span><span class="o">.</span><span class="n">failed_data_out</span><span class="o">.</span><span class="n">queue</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;stage-out has finished, proceed with final server update&#39;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;proceeding with final server update&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_job_status"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.get_job_status">[docs]</a><span class="k">def</span> <span class="nf">get_job_status</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper function around job.get_status().</span>
<span class="sd">    If key = &#39;LOG_TRANSFER&#39; but job object is not defined, the function will return value = LOG_TRANSFER_NOT_DONE.</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :param key: key name (string).</span>
<span class="sd">    :return: value (string).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">job</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">get_status</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;LOG_TRANSFER&#39;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">LOG_TRANSFER_NOT_DONE</span>

    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="queue_monitor"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.queue_monitor">[docs]</a><span class="k">def</span> <span class="nf">queue_monitor</span><span class="p">(</span><span class="n">queues</span><span class="p">,</span> <span class="n">traces</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>  <span class="c1"># noqa: C901</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Monitoring of queues.</span>
<span class="sd">    This function monitors queue activity, specifically if a job has finished or failed and then reports to the server.</span>

<span class="sd">    :param queues: internal queues for job handling.</span>
<span class="sd">    :param traces: tuple containing internal pilot states.</span>
<span class="sd">    :param args: Pilot arguments (e.g. containing queue name, queuedata dictionary, etc).</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># scan queues until at least one queue has a job object. abort if it takes too long time</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">scan_for_jobs</span><span class="p">(</span><span class="n">queues</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;queues are still empty of jobs - will begin queue monitoring anyway&#39;</span><span class="p">)</span>

    <span class="n">job</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># will abort when graceful_stop has been set or if enough time has passed after kill signal</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">traces</span><span class="o">.</span><span class="n">pilot</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;abort&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;job queue monitor received an abort instruction&#39;</span><span class="p">)</span>
            <span class="n">args</span><span class="o">.</span><span class="n">graceful_stop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="c1"># abort in case graceful_stop has been set, and less than 30 s has passed since MAXTIME was reached (if set)</span>
        <span class="c1"># (abort at the end of the loop)</span>
        <span class="n">abort_thread</span> <span class="o">=</span> <span class="n">should_abort</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;job:queue_monitor&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">abort_thread</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PILOT_WRAP_UP&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NORMAL&#39;</span><span class="p">:</span>
            <span class="n">pause_queue_monitor</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

        <span class="c1"># check if the job has finished</span>
        <span class="n">imax</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">imax</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PILOT_WRAP_UP&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;NORMAL&#39;</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">get_finished_or_failed_job</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">queues</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">job</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;returned job has state=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
                <span class="c1">#if job.state == &#39;failed&#39;:</span>
                <span class="c1">#    logger.warning(&#39;will abort failed job (should prepare for final server update)&#39;)</span>
                <span class="k">break</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">get_pilot_state</span><span class="p">()</span>  <span class="c1"># the job object is not available, but the state is also kept in PILOT_JOB_STATE</span>
            <span class="k">if</span> <span class="n">state</span> <span class="o">!=</span> <span class="s1">&#39;stage-out&#39;</span><span class="p">:</span>
                <span class="c1"># logger.info(&quot;no need to wait since job state=\&#39;%s\&#39;&quot; % state)</span>
                <span class="k">break</span>
            <span class="n">pause_queue_monitor</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">abort_thread</span> <span class="k">else</span> <span class="n">pause_queue_monitor</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># job has not been defined if it&#39;s still running</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">abort_thread</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">completed_jobids</span> <span class="o">=</span> <span class="n">queues</span><span class="o">.</span><span class="n">completed_jobids</span><span class="o">.</span><span class="n">queue</span> <span class="k">if</span> <span class="n">queues</span><span class="o">.</span><span class="n">completed_jobids</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">job</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">jobid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">completed_jobids</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;preparing for final server update for job </span><span class="si">%s</span><span class="s2"> in state=</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">job_aborted</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="c1"># wait for stage-out to finish for aborted job</span>
                <span class="n">wait_for_aborted_job_stageout</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">queues</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>

            <span class="c1"># send final server update</span>
            <span class="n">update_server</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

            <span class="c1"># we can now stop monitoring this job, so remove it from the monitored_payloads queue and add it to the</span>
            <span class="c1"># completed_jobs queue which will tell retrieve() that it can download another job</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_job</span> <span class="o">=</span> <span class="n">queues</span><span class="o">.</span><span class="n">monitored_payloads</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;failed to dequeue job: queue is empty (did job fail before job monitor started?)&#39;</span><span class="p">)</span>
                <span class="n">make_job_report</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;job </span><span class="si">%s</span><span class="s1"> was dequeued from the monitored payloads queue&#39;</span> <span class="o">%</span> <span class="n">_job</span><span class="o">.</span><span class="n">jobid</span><span class="p">)</span>
                <span class="c1"># now ready for the next job (or quit)</span>
                <span class="n">put_in_queue</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">,</span> <span class="n">queues</span><span class="o">.</span><span class="n">completed_jobids</span><span class="p">)</span>

                <span class="n">put_in_queue</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">queues</span><span class="o">.</span><span class="n">completed_jobs</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">_job</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;tmp job object deleted&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">abort_thread</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="c1"># proceed to set the job_aborted flag?</span>
    <span class="k">if</span> <span class="n">threads_aborted</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;will proceed to set job_aborted&#39;</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">job_aborted</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;will not set job_aborted yet&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;[job] queue monitor thread has finished&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_server"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.update_server">[docs]</a><span class="k">def</span> <span class="nf">update_server</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the server (wrapper for send_state() that also prepares the metadata).</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :param args: pilot args object.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">Payload</span><span class="o">.</span><span class="n">jobreport</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">read_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># read_json(path)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;metadata=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metadata</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">fileinfo</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;xml:will send fileinfo&#39;</span><span class="p">)</span>
        <span class="n">send_state</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">xml</span><span class="o">=</span><span class="n">dumps</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">fileinfo</span><span class="p">),</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;will not send fileinfo&#39;</span><span class="p">)</span>
        <span class="n">send_state</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span></div>


<div class="viewcode-block" id="pause_queue_monitor"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.pause_queue_monitor">[docs]</a><span class="k">def</span> <span class="nf">pause_queue_monitor</span><span class="p">(</span><span class="n">delay</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pause the queue monitor to let log transfer complete.</span>
<span class="sd">    Note: this function should use globally available object. Use sleep for now.</span>
<span class="sd">    :param delay: sleep time in seconds (int).</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;since job:queue_monitor is responsible for sending job updates, we sleep for </span><span class="si">%d</span><span class="s1"> s&#39;</span> <span class="o">%</span> <span class="n">delay</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_finished_or_failed_job"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.get_finished_or_failed_job">[docs]</a><span class="k">def</span> <span class="nf">get_finished_or_failed_job</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">queues</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the job has either finished or failed and if so return it.</span>
<span class="sd">    If failed, order a log transfer. If the job is in state &#39;failed&#39; and abort_job is set, set job_aborted.</span>

<span class="sd">    :param args: pilot args object.</span>
<span class="sd">    :param queues: pilot queues object.</span>
<span class="sd">    :return: job object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">job</span> <span class="o">=</span> <span class="n">get_job_from_queue</span><span class="p">(</span><span class="n">queues</span><span class="p">,</span> <span class="s2">&quot;finished&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">job</span><span class="p">:</span>
        <span class="c1"># logger.debug(&#39;get_finished_or_failed_job: job has finished&#39;)</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># logger.debug(&#39;check_job: job has not finished&#39;)</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">get_job_from_queue</span><span class="p">(</span><span class="n">queues</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">job</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;get_finished_or_failed_job: job has failed&#39;</span><span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;failed&#39;</span>
            <span class="n">args</span><span class="o">.</span><span class="n">job_aborted</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="c1"># get the current log transfer status</span>
            <span class="n">log_transfer</span> <span class="o">=</span> <span class="n">get_job_status</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s1">&#39;LOG_TRANSFER&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">log_transfer</span> <span class="o">==</span> <span class="n">LOG_TRANSFER_NOT_DONE</span><span class="p">:</span>
                <span class="c1"># order a log transfer for a failed job</span>
                <span class="n">order_log_transfer</span><span class="p">(</span><span class="n">queues</span><span class="p">,</span> <span class="n">job</span><span class="p">)</span>

    <span class="c1"># check if the job has failed</span>
    <span class="k">if</span> <span class="n">job</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;failed&#39;</span><span class="p">:</span>
        <span class="c1"># set job_aborted in case of kill signals</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">abort_job</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;queue monitor detected a set abort_job (due to a kill signal)&#39;</span><span class="p">)</span>
            <span class="c1"># do not set graceful stop if pilot has not finished sending the final job update</span>
            <span class="c1"># i.e. wait until SERVER_UPDATE is DONE_FINAL</span>
            <span class="c1">#check_for_final_server_update(args.update_server)</span>
            <span class="c1">#args.job_aborted.set()</span>

    <span class="k">return</span> <span class="n">job</span></div>


<div class="viewcode-block" id="get_heartbeat_period"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.get_heartbeat_period">[docs]</a><span class="k">def</span> <span class="nf">get_heartbeat_period</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the proper heartbeat period, as determined by normal or debug mode.</span>
<span class="sd">    In normal mode, the heartbeat period is 30*60 s, while in debug mode it is 5*60 s. Both values are defined in the</span>
<span class="sd">    config file.</span>

<span class="sd">    :param debug: Boolean, True for debug mode. False otherwise.</span>
<span class="sd">    :return: heartbeat period (int).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">heartbeat</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">debug</span> <span class="k">else</span> <span class="n">config</span><span class="o">.</span><span class="n">Pilot</span><span class="o">.</span><span class="n">debug_heartbeat</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;bad config data for heartbeat period: </span><span class="si">%s</span><span class="s1"> (will use default 1800 s)&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1800</span></div>


<div class="viewcode-block" id="check_for_abort_job"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.check_for_abort_job">[docs]</a><span class="k">def</span> <span class="nf">check_for_abort_job</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if args.abort_job.is_set().</span>
<span class="sd">    This flag should</span>

<span class="sd">    :param args: Pilot arguments (e.g. containing queue name, queuedata dictionary, etc).</span>
<span class="sd">    :param caller: function name of caller (string).</span>
<span class="sd">    :return: Boolean, True if args_job.is_set()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">abort_job</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">abort_job</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> detected an abort_job request (signal=</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">caller</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">signal</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;in case pilot is running more than one job, all jobs will be aborted&#39;</span><span class="p">)</span>
        <span class="n">abort_job</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">abort_job</span></div>


<div class="viewcode-block" id="interceptor"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.interceptor">[docs]</a><span class="k">def</span> <span class="nf">interceptor</span><span class="p">(</span><span class="n">queues</span><span class="p">,</span> <span class="n">traces</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MOVE THIS TO INTERCEPTOR.PY; TEMPLATE FOR THREADS</span>

<span class="sd">    :param queues: internal queues for job handling.</span>
<span class="sd">    :param traces: tuple containing internal pilot states.</span>
<span class="sd">    :param args: Pilot arguments (e.g. containing queue name, queuedata dictionary, etc).</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># overall loop counter (ignoring the fact that more than one job may be running)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">graceful_stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># abort in case graceful_stop has been set, and less than 30 s has passed since MAXTIME was reached (if set)</span>
        <span class="c1"># (abort at the end of the loop)</span>
        <span class="n">abort</span> <span class="o">=</span> <span class="n">should_abort</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;job:interceptor&#39;</span><span class="p">)</span>

        <span class="c1"># check for any abort_job requests</span>
        <span class="n">abort_job</span> <span class="o">=</span> <span class="n">check_for_abort_job</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="s1">&#39;interceptor&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">abort_job</span><span class="p">:</span>
            <span class="c1"># peek at the jobs in the validated_jobs queue and send the running ones to the heartbeat function</span>
            <span class="n">jobs</span> <span class="o">=</span> <span class="n">queues</span><span class="o">.</span><span class="n">monitored_payloads</span><span class="o">.</span><span class="n">queue</span>
            <span class="k">if</span> <span class="n">jobs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)):</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;interceptor loop </span><span class="si">%d</span><span class="s1">: looking for communication file&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">abort</span> <span class="ow">or</span> <span class="n">abort_job</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="c1"># proceed to set the job_aborted flag?</span>
    <span class="k">if</span> <span class="n">threads_aborted</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;will proceed to set job_aborted&#39;</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">job_aborted</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;will not set job_aborted yet&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;[job] interceptor thread has finished&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="job_monitor"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.job_monitor">[docs]</a><span class="k">def</span> <span class="nf">job_monitor</span><span class="p">(</span><span class="n">queues</span><span class="p">,</span> <span class="n">traces</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>  <span class="c1"># noqa: C901</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Monitoring of job parameters.</span>
<span class="sd">    This function monitors certain job parameters, such as job looping, at various time intervals. The main loop</span>
<span class="sd">    is executed once a minute, while individual verifications may be executed at any time interval (&gt;= 1 minute). E.g.</span>
<span class="sd">    looping jobs are checked once per ten minutes (default) and the heartbeat is send once per 30 minutes. Memory</span>
<span class="sd">    usage is checked once a minute.</span>

<span class="sd">    :param queues: internal queues for job handling.</span>
<span class="sd">    :param traces: tuple containing internal pilot states.</span>
<span class="sd">    :param args: Pilot arguments (e.g. containing queue name, queuedata dictionary, etc).</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># initialize the monitoring time object</span>
    <span class="n">mt</span> <span class="o">=</span> <span class="n">MonitoringTime</span><span class="p">()</span>

    <span class="c1"># peeking and current time; peeking_time gets updated if and when jobs are being monitored, update_time is only</span>
    <span class="c1"># used for sending the heartbeat and is updated after a server update</span>
    <span class="n">peeking_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">update_time</span> <span class="o">=</span> <span class="n">peeking_time</span>

    <span class="c1"># overall loop counter (ignoring the fact that more than one job may be running)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">graceful_stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># abort in case graceful_stop has been set, and less than 30 s has passed since MAXTIME was reached (if set)</span>
        <span class="c1"># (abort at the end of the loop)</span>
        <span class="n">abort</span> <span class="o">=</span> <span class="n">should_abort</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;job:job_monitor&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">traces</span><span class="o">.</span><span class="n">pilot</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;command&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;abort&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;job monitor received an abort command&#39;</span><span class="p">)</span>

        <span class="c1"># check for any abort_job requests</span>
        <span class="n">abort_job</span> <span class="o">=</span> <span class="n">check_for_abort_job</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">caller</span><span class="o">=</span><span class="s1">&#39;job monitor&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">abort_job</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">queues</span><span class="o">.</span><span class="n">current_data_in</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                <span class="c1"># make sure to send heartbeat regularly if stage-in takes a long time</span>
                <span class="n">jobs</span> <span class="o">=</span> <span class="n">queues</span><span class="o">.</span><span class="n">current_data_in</span><span class="o">.</span><span class="n">queue</span>
                <span class="k">if</span> <span class="n">jobs</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)):</span>
                        <span class="c1"># send heartbeat if it is time (note that the heartbeat function might update the job object, e.g.</span>
                        <span class="c1"># by turning on debug mode, ie we need to get the heartbeat period in case it has changed)</span>
                        <span class="n">update_time</span> <span class="o">=</span> <span class="n">send_heartbeat_if_time</span><span class="p">(</span><span class="n">jobs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">args</span><span class="p">,</span> <span class="n">update_time</span><span class="p">)</span>

                    <span class="c1"># sleep for a while if stage-in has not completed</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">queues</span><span class="o">.</span><span class="n">finished_data_in</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                <span class="c1"># sleep for a while if stage-in has not completed</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>

        <span class="c1"># peek at the jobs in the validated_jobs queue and send the running ones to the heartbeat function</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="n">queues</span><span class="o">.</span><span class="n">monitored_payloads</span><span class="o">.</span><span class="n">queue</span>
        <span class="k">if</span> <span class="n">jobs</span><span class="p">:</span>
            <span class="c1"># update the peeking time</span>
            <span class="n">peeking_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)):</span>
                <span class="n">current_id</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">jobid</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;monitor loop #</span><span class="si">%d</span><span class="s1">: job </span><span class="si">%d</span><span class="s1">:</span><span class="si">%s</span><span class="s1"> is in state </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">current_id</span><span class="p">,</span> <span class="n">jobs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">jobs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;finished&#39;</span> <span class="ow">or</span> <span class="n">jobs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;failed&#39;</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;will abort job monitoring soon since job state=</span><span class="si">%s</span><span class="s1"> (job is still in queue)&#39;</span> <span class="o">%</span> <span class="n">jobs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="c1"># perform the monitoring tasks</span>
                <span class="n">exit_code</span><span class="p">,</span> <span class="n">diagnostics</span> <span class="o">=</span> <span class="n">job_monitor_tasks</span><span class="p">(</span><span class="n">jobs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mt</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">exit_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fail_monitored_job</span><span class="p">(</span><span class="n">jobs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">diagnostics</span><span class="p">,</span> <span class="n">queues</span><span class="p">,</span> <span class="n">traces</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;(1) exception caught: </span><span class="si">%s</span><span class="s1"> (job id=</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">current_id</span><span class="p">))</span>
                    <span class="k">break</span>

                <span class="c1"># run this check again in case job_monitor_tasks() takes a long time to finish (and the job object</span>
                <span class="c1"># has expired in the mean time)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_job</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;aborting job monitoring since job object (job id=</span><span class="si">%s</span><span class="s1">) has expired&#39;</span> <span class="o">%</span> <span class="n">current_id</span><span class="p">)</span>
                    <span class="k">break</span>

                <span class="c1"># send heartbeat if it is time (note that the heartbeat function might update the job object, e.g.</span>
                <span class="c1"># by turning on debug mode, ie we need to get the heartbeat period in case it has changed)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">update_time</span> <span class="o">=</span> <span class="n">send_heartbeat_if_time</span><span class="p">(</span><span class="n">_job</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">update_time</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;(2) exception caught: </span><span class="si">%s</span><span class="s1"> (job id=</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">current_id</span><span class="p">))</span>
                    <span class="k">break</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PILOT_JOB_STATE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;stagein&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;job monitoring is waiting for stage-in to finish&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># check the waiting time in the job monitor. set global graceful_stop if necessary</span>
            <span class="n">check_job_monitor_waiting_time</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">peeking_time</span><span class="p">,</span> <span class="n">abort_override</span><span class="o">=</span><span class="n">abort_job</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">abort</span> <span class="ow">or</span> <span class="n">abort_job</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="c1"># proceed to set the job_aborted flag?</span>
    <span class="k">if</span> <span class="n">threads_aborted</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;will proceed to set job_aborted&#39;</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">job_aborted</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;will not set job_aborted yet&#39;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;[job] job monitor thread has finished&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="send_heartbeat_if_time"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.send_heartbeat_if_time">[docs]</a><span class="k">def</span> <span class="nf">send_heartbeat_if_time</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">update_time</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send a heartbeat to the server if it is time to do so.</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :param args: args object.</span>
<span class="sd">    :param update_time: last update time (from time.time()).</span>
<span class="sd">    :return: possibly updated update_time (from time.time()).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">-</span> <span class="n">update_time</span> <span class="o">&gt;=</span> <span class="n">get_heartbeat_period</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">debug</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">serverstate</span> <span class="o">!=</span> <span class="s1">&#39;finished&#39;</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">serverstate</span> <span class="o">!=</span> <span class="s1">&#39;failed&#39;</span><span class="p">:</span>
            <span class="n">send_state</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;running&#39;</span><span class="p">)</span>
            <span class="n">update_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">update_time</span></div>


<div class="viewcode-block" id="check_job_monitor_waiting_time"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.check_job_monitor_waiting_time">[docs]</a><span class="k">def</span> <span class="nf">check_job_monitor_waiting_time</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">peeking_time</span><span class="p">,</span> <span class="n">abort_override</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check the waiting time in the job monitor.</span>
<span class="sd">    Set global graceful_stop if necessary.</span>

<span class="sd">    :param args: args object.</span>
<span class="sd">    :param peeking_time: time when monitored_payloads queue was peeked into (int).</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">waiting_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">-</span> <span class="n">peeking_time</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;no jobs in monitored_payloads queue (waited for </span><span class="si">%d</span><span class="s1"> s)&#39;</span> <span class="o">%</span> <span class="n">waiting_time</span>
    <span class="k">if</span> <span class="n">waiting_time</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">:</span>
        <span class="n">abort</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39; - aborting&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">abort</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">abort</span> <span class="ow">or</span> <span class="n">abort_override</span><span class="p">:</span>
        <span class="c1"># do not set graceful stop if pilot has not finished sending the final job update</span>
        <span class="c1"># i.e. wait until SERVER_UPDATE is DONE_FINAL</span>
        <span class="n">check_for_final_server_update</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">update_server</span><span class="p">)</span>
        <span class="n">args</span><span class="o">.</span><span class="n">graceful_stop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span></div>


<div class="viewcode-block" id="fail_monitored_job"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.fail_monitored_job">[docs]</a><span class="k">def</span> <span class="nf">fail_monitored_job</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">exit_code</span><span class="p">,</span> <span class="n">diagnostics</span><span class="p">,</span> <span class="n">queues</span><span class="p">,</span> <span class="n">traces</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fail a monitored job.</span>

<span class="sd">    :param job: job object</span>
<span class="sd">    :param exit_code: exit code from job_monitor_tasks (int).</span>
<span class="sd">    :param diagnostics: pilot error diagnostics (string).</span>
<span class="sd">    :param queues: queues object.</span>
<span class="sd">    :param traces: traces object.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">set_pilot_state</span><span class="p">(</span><span class="n">job</span><span class="o">=</span><span class="n">job</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="s2">&quot;failed&quot;</span><span class="p">)</span>
    <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcodes</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrordiags</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">add_error_code</span><span class="p">(</span><span class="n">exit_code</span><span class="p">)</span>
    <span class="n">job</span><span class="o">.</span><span class="n">pilorerrordiag</span> <span class="o">=</span> <span class="n">diagnostics</span>
    <span class="n">traces</span><span class="o">.</span><span class="n">pilot</span><span class="p">[</span><span class="s1">&#39;error_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exit_code</span>
    <span class="n">put_in_queue</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">queues</span><span class="o">.</span><span class="n">failed_payloads</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;aborting job monitoring since job state=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">state</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_job_report"><a class="viewcode-back" href="../../../components/control/job.html#pilot.control.job.make_job_report">[docs]</a><span class="k">def</span> <span class="nf">make_job_report</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make a summary report for the given job.</span>
<span class="sd">    This function is called when the job has completed.</span>

<span class="sd">    :param job: job object.</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;job summary report&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PanDA job id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">jobid</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;task id: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">taskid</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">piloterrorcodes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;error </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">: </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcodes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrordiags</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;errors: (none)&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pilot error code: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrorcode</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pilot error diag: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">piloterrordiag</span><span class="p">)</span>
    <span class="n">info</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">+=</span> <span class="n">key</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;status: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">info</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_analysis</span><span class="p">()</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="s1">&#39;finished&#39;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;(user job is recoverable)&#39;</span> <span class="k">if</span> <span class="n">errors</span><span class="o">.</span><span class="n">is_recoverable</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="n">job</span><span class="o">.</span><span class="n">piloterrorcode</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;(user job is not recoverable)&#39;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pilot state: </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;transexitcode: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">transexitcode</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;exeerrorcode: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">exeerrorcode</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;exeerrordiag: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">exeerrordiag</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;exitcode: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">exitcode</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;exitmsg: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">exitmsg</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cpuconsumptiontime: </span><span class="si">%d</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">cpuconsumptiontime</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">cpuconsumptionunit</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;nevents: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">nevents</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;neventsw: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">neventsw</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pid: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;pgrp: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">pgrp</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;corecount: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">job</span><span class="o">.</span><span class="n">corecount</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;event service: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">is_eventservice</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;sizes: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">sizes</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;--------------------------------------------------&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Pilot 2</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/index.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../components/index.html">Components</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Paul Nilsson, Mario Lassnig, Daniil Drizhuk, ....
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>